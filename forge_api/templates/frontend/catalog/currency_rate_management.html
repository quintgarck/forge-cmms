{% extends 'frontend/base/base.html' %}
{% load static %}

{% block title %}Gestión de Tasas de Cambio - MovIAx{% endblock %}

{% block body_class %}catalog-page{% endblock %}

{% block extra_css %}
<style>
    /* Modal COMPLETAMENTE INDEPENDIENTE - forzar posición fixed */
    #editRateModal {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 9999999 !important;
        display: none !important;
    }
    #editRateModal.show {
        display: flex !important;
    }
    #editRateModal.show .modal-dialog {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        margin: 0 !important;
        max-width: 500px;
        width: 90% !important;
    }
    #editRateModal .modal-backdrop {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 9999998 !important;
        opacity: 0.3 !important;
        pointer-events: none !important;
    }
    #editRateModal .modal-content {
        pointer-events: auto !important;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
        border: none !important;
        background: #fff !important;
        color: #212529 !important;
    }
    #editRateModal .modal-header,
    #editRateModal .modal-body,
    #editRateModal .modal-footer {
        pointer-events: auto !important;
    }
    #editRateModal .modal-body input {
        pointer-events: auto !important;
        background: #fff !important;
        color: #212529 !important;
        border: 1px solid #ced4da !important;
    }
    #editRateModal .modal-body input:focus {
        outline: none !important;
        border-color: #86b7fe !important;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
    }
    #editRateModal .modal-footer button {
        pointer-events: auto !important;
    }
    
    /* Forzar que ningún elemento del modal sea bloqueado */
    #editRateModal * {
        pointer-events: auto !important;
    }
    
    .rate-card {
        transition: all 0.3s ease;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .rate-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #007bff;
    }
    .rate-value {
        font-size: 1.3rem;
        font-weight: 600;
        color: #0d6efd;
        font-family: 'Courier New', monospace;
    }
    .rate-change {
        font-size: 0.85rem;
        font-weight: 600;
    }
    .rate-up {
        color: #28a745;
    }
    .rate-down {
        color: #dc3545;
    }
    .rate-stable {
        color: #6c757d;
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .update-log {
        max-height: 300px;
        overflow-y: auto;
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
    }
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }
    
    /* Badge bg-secondary - legible en dark mode */
    .badge.bg-secondary {
        background-color: #6c757d !important;
        color: #ffffff !important;
    }
    [data-theme="dark"] .badge.bg-secondary {
        background-color: #475569 !important;
        color: #f8f9fa !important;
    }
    
    /* Badge en tabla */
    .table .badge {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-currency-exchange text-primary me-2"></i>
                        Gestión de Tasas de Cambio
                    </h1>
                    <p class="text-muted mb-0">Actualización y monitoreo de tasas de cambio</p>
                </div>
                <div>
                    <div class="btn-group me-2">
                        <a href="{% url 'frontend:currency_history_comparison' %}" class="btn btn-info">
                            <i class="bi bi-bar-chart me-1"></i>
                            Comparar Monedas
                        </a>
                    </div>
                    <button class="btn btn-success me-2" id="updateAllRates">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        <span class="btn-text">Actualizar Todas las Tasas</span>
                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                    </button>
                    <a href="{% url 'frontend:currency_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>
                        Volver a Monedas
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <h6 class="mb-2">Total Monedas</h6>
                <h2 class="mb-0">{{ total_currencies }}</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <h6 class="mb-2">Monedas Activas</h6>
                <h2 class="mb-0">{{ active_currencies }}</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <h6 class="mb-2">Moneda Base</h6>
                <h2 class="mb-0">{{ base_currency.code|default:"N/A" }}</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <h6 class="mb-2">Última Actualización</h6>
                <h2 class="mb-0"><small>{{ last_update.timestamp|date:"H:i" }}</small></h2>
            </div>
        </div>
    </div>

    <!-- Información de Moneda Base -->
    {% if base_currency %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Moneda Base:</strong> {{ base_currency.name }} ({{ base_currency.code }})
        - Todas las tasas se calculan en relación a esta moneda.
    </div>
    {% endif %}

    <div class="row">
        <!-- Tabla de Tasas -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-table me-2"></i>
                        Tasas Actuales
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Moneda</th>
                                    <th>Código</th>
                                    <th>Tasa Actual</th>
                                    <th>Cambio (7d)</th>
                                    <th>Última Act.</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for currency in currencies %}
                                <tr data-currency-code="{{ currency.currency_code }}">
                                    <td>
                                        <strong>{{ currency.name }}</strong>
                                        {% if currency.is_base_currency %}
                                        <span class="badge bg-warning text-dark ms-2">Base</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ currency.currency_code }}</span>
                                    </td>
                                    <td>
                                        <span class="rate-value">{{ currency.exchange_rate_formatted }}</span>
                                    </td>
                                    <td>
                                        {% if not currency.is_base_currency %}
                                        <span class="rate-change rate-{{ currency.rate_change.direction }}">
                                            {% if currency.rate_change.direction == 'up' %}
                                            <i class="bi bi-arrow-up-circle-fill"></i>
                                            {% elif currency.rate_change.direction == 'down' %}
                                            <i class="bi bi-arrow-down-circle-fill"></i>
                                            {% else %}
                                            <i class="bi bi-dash-circle-fill"></i>
                                            {% endif %}
                                            {{ currency.rate_change.change_percent|floatformat:2 }}%
                                        </span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ currency.last_updated|date:"d/m/Y H:i" }}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-sm btn-outline-primary btn-edit-rate"
                                                    data-currency-code="{{ currency.currency_code }}"
                                                    data-currency-name="{{ currency.name }}"
                                                    data-current-rate="{{ currency.exchange_rate }}"
                                                    title="Editar Tasa">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <a href="{% url 'frontend:currency_edit' pk=currency.currency_code %}" 
                                               class="btn btn-sm btn-outline-secondary"
                                               title="Editar Moneda Completa">
                                                <i class="bi bi-gear"></i>
                                            </a>
                                            <a href="{% url 'frontend:currency_detail' pk=currency.currency_code %}" 
                                               class="btn btn-sm btn-outline-info"
                                               title="Ver Detalle">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="{% url 'frontend:currency_history_enhanced' currency.currency_code %}" 
                                               class="btn btn-sm btn-outline-success"
                                               title="Histórico de Tasas">
                                                <i class="bi bi-clock-history"></i>
                                            </a>
                                            {% if not currency.is_base_currency %}
                                            <a href="{% url 'frontend:currency_delete' pk=currency.currency_code %}" 
                                               class="btn btn-sm btn-outline-danger"
                                               title="Eliminar/Inactivar">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        No hay monedas configuradas
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Lateral -->
        <div class="col-lg-4">
            <!-- Fuentes de Actualización -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-cloud-download me-2"></i>
                        Fuentes de Actualización
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="updateSource" class="form-label">Seleccionar Fuente:</label>
                        <select class="form-select" id="updateSource">
                            {% for source in available_sources %}
                            <option value="{{ source.id }}" {% if forloop.first %}selected{% endif %}>
                                {{ source.name }}
                                {% if source.free %}(Gratis){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted d-block mt-2" id="sourceDescription">
                            API gratuita sin necesidad de registro
                        </small>
                    </div>
                    <button class="btn btn-success w-100" id="updateFromSource">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Actualizar Desde Fuente
                    </button>
                </div>
            </div>

            <!-- Log de Actualizaciones -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        Log de Actualizaciones
                    </h6>
                </div>
                <div class="card-body">
                    <div class="update-log" id="updateLog">
                        <p class="text-muted text-center">No hay actualizaciones recientes</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Tasa -->
<div class="modal fade" id="editRateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Actualizar Tasa de Cambio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editRateForm">
                    <input type="hidden" id="editCurrencyCode">
                    <div class="mb-3">
                        <label class="form-label">Moneda:</label>
                        <p class="form-control-plaintext" id="editCurrencyName"></p>
                    </div>
                    <div class="mb-3">
                        <label for="editCurrentRate" class="form-label">Tasa Actual:</label>
                        <input type="text" class="form-control" id="editCurrentRate" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editNewRate" class="form-label">Nueva Tasa:</label>
                        <input type="number" 
                               class="form-control" 
                               id="editNewRate" 
                               step="0.0001" 
                               min="0.0001"
                               required>
                        <small class="text-muted">Ingrese la nueva tasa de cambio</small>
                    </div>
                    <div class="alert alert-warning" id="rateWarning" style="display: none;">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span id="rateWarningText"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveRate">
                    <i class="bi bi-save me-1"></i>
                    Guardar Tasa
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Mover el modal al final del body para que esté completamente independiente
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('editRateModal');
    if (modal) {
        document.body.appendChild(modal);
        console.log('Modal movido al final del body');
    }
    
    // Verificar que Bootstrap esté disponible
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap no está cargado');
        return;
    }
    
    // Obtener elementos del modal con verificación nula
    const editRateModalEl = document.getElementById('editRateModal');
    if (!editRateModalEl) {
        console.warn('Modal de editar tasa no encontrado');
        return;
    }
    
    const editRateModal = new bootstrap.Modal(editRateModalEl);
    
    // Elementos del formulario
    const editCurrencyCodeEl = document.getElementById('editCurrencyCode');
    const editCurrencyNameEl = document.getElementById('editCurrencyName');
    const editCurrentRateEl = document.getElementById('editCurrentRate');
    const editNewRateEl = document.getElementById('editNewRate');
    const rateWarningEl = document.getElementById('rateWarning');
    const rateWarningTextEl = document.getElementById('rateWarningText');
    const saveRateBtnEl = document.getElementById('saveRate');
    const updateAllRatesBtnEl = document.getElementById('updateAllRates');
    const updateFromSourceBtnEl = document.getElementById('updateFromSource');
    const updateSourceEl = document.getElementById('updateSource');
    const sourceDescriptionEl = document.getElementById('sourceDescription');
    const updateLogEl = document.getElementById('updateLog');
    
    // Actualizar todas las tasas
    if (updateAllRatesBtnEl) {
        updateAllRatesBtnEl.addEventListener('click', function() {
            if (confirm('¿Desea actualizar todas las tasas desde la fuente externa? Esto puede tomar unos momentos.')) {
                updateAllRates();
            }
        });
    }
    
    // Actualizar desde fuente seleccionada
    if (updateFromSourceBtnEl) {
        updateFromSourceBtnEl.addEventListener('click', function() {
            const source = updateSourceEl ? updateSourceEl.value : 'exchangerate-api';
            if (confirm(`¿Desea actualizar las tasas desde ${source}?`)) {
                updateAllRates(source);
            }
        });
    }
    
    // Cambiar descripción de fuente
    if (updateSourceEl) {
        updateSourceEl.addEventListener('change', function() {
            const descriptions = {
                'exchangerate-api': 'API gratuita sin necesidad de registro',
                'fixer': 'API profesional (requiere API key configurada)'
            };
            if (sourceDescriptionEl) {
                sourceDescriptionEl.textContent = descriptions[this.value] || '';
            }
        });
    }
    
    // Editar tasa individual
    const editButtons = document.querySelectorAll('.btn-edit-rate');
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const currencyCode = this.dataset.currencyCode;
            const currencyName = this.dataset.currencyName;
            const currentRate = this.dataset.currentRate;
            
            // Verificar que los elementos existan antes de usarlos
            if (editCurrencyCodeEl) editCurrencyCodeEl.value = currencyCode;
            if (editCurrencyNameEl) editCurrencyNameEl.textContent = `${currencyName} (${currencyCode})`;
            if (editCurrentRateEl) editCurrentRateEl.value = currentRate;
            if (editNewRateEl) editNewRateEl.value = currentRate;
            if (rateWarningEl) rateWarningEl.style.display = 'none';
            
            editRateModal.show();
        });
    });
    
    // Validar nueva tasa
    if (editNewRateEl) {
        editNewRateEl.addEventListener('input', function() {
            const newRate = parseFloat(this.value);
            const currentRate = editCurrentRateEl ? parseFloat(editCurrentRateEl.value) : 0;
            
            if (newRate && currentRate) {
                const changePercent = ((newRate - currentRate) / currentRate) * 100;
                
                if (Math.abs(changePercent) > 10 && rateWarningEl && rateWarningTextEl) {
                    rateWarningEl.style.display = 'block';
                    rateWarningTextEl.textContent = 
                        `Cambio significativo: ${changePercent.toFixed(2)}%. Por favor verifica que sea correcto.`;
                } else if (rateWarningEl) {
                    rateWarningEl.style.display = 'none';
                }
            } else if (rateWarningEl) {
                rateWarningEl.style.display = 'none';
            }
        });
    }
    
    // Guardar tasa
    if (saveRateBtnEl) {
        saveRateBtnEl.addEventListener('click', function() {
            const currencyCode = editCurrencyCodeEl ? editCurrencyCodeEl.value : '';
            const newRate = editNewRateEl ? editNewRateEl.value : '';
            
            if (!newRate || parseFloat(newRate) <= 0) {
                alert('Por favor ingrese una tasa válida');
                return;
            }
            
            updateRate(currencyCode, newRate);
        });
    }
    
    function updateRate(currencyCode, rate) {
        if (!saveRateBtnEl) return;
        
        saveRateBtnEl.disabled = true;
        saveRateBtnEl.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';
        
        fetch('{% url "frontend:currency_rate_update" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                currency_code: currencyCode,
                rate: rate
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addToLog(`✓ ${currencyCode}: Tasa actualizada a ${rate}`);
                editRateModal.hide();
                // Recargar sin caché para ver los datos actualizados
                setTimeout(() => {
                    // Invalidar caché y recargar
                    fetch('{% url "frontend:currency_rates" %}', { 
                        method: 'GET',
                        headers: { 'Cache-Control': 'no-cache' }
                    }).then(() => {
                        window.location.reload(true); // true = force reload from server
                    }).catch(() => {
                        window.location.reload(true);
                    });
                }, 1000);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al actualizar la tasa');
        })
        .finally(() => {
            if (saveRateBtnEl) {
                saveRateBtnEl.disabled = false;
                saveRateBtnEl.innerHTML = '<i class="bi bi-save me-1"></i>Guardar Tasa';
            }
        });
    }
    
    function updateAllRates(source = 'exchangerate-api') {
        if (!updateAllRatesBtnEl) return;
        
        const btnText = updateAllRatesBtnEl.querySelector('.btn-text');
        const spinner = updateAllRatesBtnEl.querySelector('.spinner-border');
        
        updateAllRatesBtnEl.disabled = true;
        if (btnText) btnText.textContent = 'Actualizando...';
        if (spinner) spinner.classList.remove('d-none');
        
        fetch('{% url "frontend:currency_rate_update_all" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                source: source,
                base_currency: '{{ base_currency.code|default:"USD" }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addToLog(`✓ Actualización completada: ${data.updated} tasas actualizadas, ${data.failed} fallidas`);
                
                // Mostrar detalles
                if (data.results && data.results.length > 0) {
                    data.results.forEach(result => {
                        if (result.status === 'updated') {
                            addToLog(`  → ${result.currency}: ${result.old_rate} → ${result.new_rate}`);
                        } else if (result.status === 'failed' || result.status === 'skipped') {
                            addToLog(`  ✗ ${result.currency}: ${result.error}`);
                        }
                    });
                }
                
                setTimeout(() => location.reload(), 2000);
            } else {
                addToLog(`✗ Error: ${data.error}`);
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addToLog('✗ Error de conexión');
            alert('Error al actualizar las tasas');
        })
        .finally(() => {
            if (updateAllRatesBtnEl) {
                updateAllRatesBtnEl.disabled = false;
                if (btnText) btnText.textContent = 'Actualizar Todas las Tasas';
                if (spinner) spinner.classList.add('d-none');
            }
        });
    }
    
    function addToLog(message) {
        if (!updateLogEl) return;
        
        const timestamp = new Date().toLocaleTimeString();
        const entry = document.createElement('div');
        entry.className = 'mb-2 pb-2 border-bottom';
        entry.innerHTML = `<small class="text-muted">${timestamp}</small><br>${message}`;
        
        // Limpiar mensaje inicial
        const initialMsg = updateLogEl.querySelector('.text-center');
        if (initialMsg) {
            updateLogEl.innerHTML = '';
        }
        
        updateLogEl.insertBefore(entry, updateLogEl.firstChild);
        
        // Limitar a 10 entradas
        while (updateLogEl.children.length > 10) {
            updateLogEl.removeChild(updateLogEl.lastChild);
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
