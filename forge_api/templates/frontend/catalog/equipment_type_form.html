{% extends 'frontend/base/base.html' %}
{% load static %}

{% block title %}{{ title }} - MovIAx{% endblock %}

{% block body_class %}catalog-page{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 800px;
        margin: 0 auto;
    }
    .form-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.5rem;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .form-section {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
        overflow: hidden;
    }
    .form-section-header {
        background: #f8f9fa;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #dee2e6;
    }
    .form-section-body {
        padding: 1.5rem;
    }
    .color-preview {
        width: 40px;
        height: 40px;
        border-radius: 0.25rem;
        border: 2px solid #dee2e6;
        display: inline-block;
        vertical-align: middle;
    }
    .icon-preview {
        font-size: 2rem;
        color: #6c757d;
        display: inline-block;
        vertical-align: middle;
    }
    .json-editor {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }
    .validation-feedback {
        display: block;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875rem;
    }
    .validation-feedback.valid-feedback {
        color: #198754;
    }
    .validation-feedback.invalid-feedback {
        color: #dc3545;
    }
    .form-actions {
        position: sticky;
        bottom: 20px;
        background: white;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        z-index: 100;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="form-container">
        <!-- Navigation Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'frontend:catalog_index' %}">Catálogo</a></li>
                <li class="breadcrumb-item"><a href="{% url 'frontend:equipment_type_list' %}">Tipos de Equipo</a></li>
                <li class="breadcrumb-item active" aria-current="page">
                    {% if object %}Editar{% else %}Crear{% endif %}
                </li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="form-header">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="bi bi-gear-wide-connected me-3" style="font-size: 2.5rem;"></i>
                    <div>
                        <h1 class="h2 mb-0">{{ title }}</h1>
                        <p class="mb-0 opacity-75">
                            {% if object %}
                            Modificar la información del tipo de equipo
                            {% else %}
                            Agregar un nuevo tipo de equipo al catálogo
                            {% endif %}
                        </p>
                    </div>
                </div>
                <a href="{% url 'frontend:equipment_type_list' %}" class="btn btn-light btn-lg">
                    <i class="bi bi-arrow-left me-2"></i>
                    Volver a la Lista
                </a>
            </div>
        </div>

        <form method="post" id="equipment-type-form" novalidate>
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div class="form-section">
                <div class="form-section-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Información Básica
                    </h5>
                </div>
                <div class="form-section-body">
                    <div class="row g-3">
                        <!-- Type Code -->
                        <div class="col-md-6">
                            <label for="{{ form.type_code.id_for_label }}" class="form-label">
                                {{ form.type_code.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.type_code }}
                            {% if form.type_code.help_text %}
                            <div class="form-text">{{ form.type_code.help_text }}</div>
                            {% endif %}
                            {% if form.type_code.errors %}
                            <div class="validation-feedback invalid-feedback">
                                {{ form.type_code.errors.0 }}
                            </div>
                            {% endif %}
                            <div id="code-availability" class="validation-feedback" style="display: none;"></div>
                        </div>

                        <!-- Category -->
                        <div class="col-md-6">
                            <label for="{{ form.category.id_for_label }}" class="form-label">
                                {{ form.category.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.category }}
                            {% if form.category.help_text %}
                            <div class="form-text">{{ form.category.help_text }}</div>
                            {% endif %}
                            {% if form.category.errors %}
                            <div class="validation-feedback invalid-feedback">
                                {{ form.category.errors.0 }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Name -->
                        <div class="col-12">
                            <label for="{{ form.name.id_for_label }}" class="form-label">
                                {{ form.name.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.name }}
                            {% if form.name.help_text %}
                            <div class="form-text">{{ form.name.help_text }}</div>
                            {% endif %}
                            {% if form.name.errors %}
                            <div class="validation-feedback invalid-feedback">
                                {{ form.name.errors.0 }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Description -->
                        <div class="col-12">
                            <label for="{{ form.description.id_for_label }}" class="form-label">
                                {{ form.description.label }}
                            </label>
                            {{ form.description }}
                            {% if form.description.help_text %}
                            <div class="form-text">{{ form.description.help_text }}</div>
                            {% endif %}
                            {% if form.description.errors %}
                            <div class="validation-feedback invalid-feedback">
                                {{ form.description.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visual Settings -->
            <div class="form-section">
                <div class="form-section-header">
                    <h5 class="mb-0">
                        <i class="bi bi-palette me-2"></i>
                        Configuración Visual
                    </h5>
                </div>
                <div class="form-section-body">
                    <div class="row g-3">
                        <!-- Icon -->
                        <div class="col-md-6">
                            <label for="{{ form.icon.id_for_label }}" class="form-label">
                                {{ form.icon.label }}
                            </label>
                            <div class="input-group">
                                {{ form.icon }}
                                <span class="input-group-text">
                                    <i id="icon-preview" class="icon-preview bi bi-gear"></i>
                                </span>
                            </div>
                            {% if form.icon.help_text %}
                            <div class="form-text">{{ form.icon.help_text }}</div>
                            {% endif %}
                            {% if form.icon.errors %}
                            <div class="validation-feedback invalid-feedback">
                                {{ form.icon.errors.0 }}
                            </div>
                            {% endif %}
                            <div class="form-text">
                                Ejemplos: fas fa-car, bi bi-truck, fas fa-cogs
                            </div>
                        </div>

                        <!-- Color -->
                        <div class="col-md-6">
                            <label for="{{ form.color.id_for_label }}" class="form-label">
                                {{ form.color.label }}
                            </label>
                            <div class="input-group">
                                {{ form.color }}
                                <span class="input-group-text">
                                    <div id="color-preview" class="color-preview" style="background-color: #007bff;"></div>
                                </span>
                            </div>
                            {% if form.color.help_text %}
                            <div class="form-text">{{ form.color.help_text }}</div>
                            {% endif %}
                            {% if form.color.errors %}
                            <div class="validation-feedback invalid-feedback">
                                {{ form.color.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attributes Schema -->
            <div class="form-section">
                <div class="form-section-header">
                    <h5 class="mb-0">
                        <i class="bi bi-code-square me-2"></i>
                        Esquema de Atributos
                    </h5>
                </div>
                <div class="form-section-body">
                    <div class="row">
                        <div class="col-12">
                            <p class="text-muted mb-3">
                                Define atributos personalizados que tendrán todos los equipos de este tipo.
                                Por ejemplo: marca, modelo, año, color, etc.
                            </p>
                            
                            <!-- Visual Attribute Builder -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Constructor Visual de Atributos</h6>
                                </div>
                                <div class="card-body">
                                    <div id="attribute-builder">
                                        <!-- Dynamic attribute rows will be added here -->
                                    </div>
                                    
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="add-attribute">
                                        <i class="bi bi-plus-lg me-1"></i>
                                        Agregar Atributo
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Hidden JSON field - This is the primary field used by the visual builder -->
                            <div style="display: none;">
                                {{ form.attr_schema }}
                            </div>
                            
                            <!-- Sync indicator -->
                            <div id="json-sync-indicator" class="validation-feedback" style="display: none;"></div>
                            
                            <!-- Manual JSON Editor (hidden by default) -->
                            <div class="mt-3">
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#manual-json">
                                    <i class="bi bi-code me-1"></i>
                                    Editor JSON Avanzado
                                </button>
                                <div class="collapse mt-2" id="manual-json">
                                    <div class="card card-body bg-light">
                                        <label for="{{ form.attr_schema.id_for_label }}_manual" class="form-label">
                                            {{ form.attr_schema.label }} (Manual)
                                        </label>
                                        <textarea id="{{ form.attr_schema.id_for_label }}_manual" 
                                                  class="form-control json-editor"
                                                  rows="6"
                                                  placeholder='{"brand": {"type": "string", "required": true}, "model": {"type": "string", "required": true}}'>{{ form.attr_schema.value|default:'' }}</textarea>
                                        {% if form.attr_schema.help_text %}
                                        <div class="form-text">{{ form.attr_schema.help_text }}</div>
                                        {% endif %}
                                        {% if form.attr_schema.errors %}
                                        <div class="validation-feedback invalid-feedback">
                                            {{ form.attr_schema.errors.0 }}
                                        </div>
                                        {% endif %}
                                        <div id="json-validation" class="validation-feedback" style="display: none;"></div>
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-primary btn-sm" id="sync-json-btn">
                                                <i class="bi bi-arrow-down me-1"></i>
                                                Sincronizar al Constructor Visual
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Help Section -->
                            <div class="mt-3">
                                <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="collapse" data-bs-target="#schema-help">
                                    <i class="bi bi-question-circle me-1"></i>
                                    ¿Cómo funciona?
                                </button>
                                <div class="collapse mt-2" id="schema-help">
                                    <div class="card card-body">
                                        <h6>Tipos de Atributos Disponibles:</h6>
                                        <ul class="mb-3">
                                            <li><strong>Texto:</strong> Para nombres, descripciones, códigos</li>
                                            <li><strong>Número:</strong> Para años, cantidades, medidas</li>
                                            <li><strong>Booleano:</strong> Para sí/no, verdadero/falso</li>
                                            <li><strong>Fecha:</strong> Para fechas de fabricación, compra</li>
                                            <li><strong>Selección:</strong> Para opciones predefinidas</li>
                                        </ul>
                                        <h6>Ejemplo práctico:</h6>
                                        <p class="mb-1"><strong>Tipo de equipo:</strong> "Automóvil"</p>
                                        <p class="mb-2"><strong>Atributos sugeridos:</strong></p>
                                        <ul>
                                            <li>Marca (texto, requerido)</li>
                                            <li>Modelo (texto, requerido)</li>
                                            <li>Año (número, opcional)</li>
                                            <li>Color (selección: Rojo, Azul, Negro, Blanco)</li>
                                            <li>Es eléctrico (booleano)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status -->
            <div class="form-section">
                <div class="form-section-header">
                    <h5 class="mb-0">
                        <i class="bi bi-toggle-on me-2"></i>
                        Estado
                    </h5>
                </div>
                <div class="form-section-body">
                    <div class="form-check form-switch">
                        {{ form.is_active }}
                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                            {{ form.is_active.label }}
                        </label>
                        {% if form.is_active.help_text %}
                        <div class="form-text">{{ form.is_active.help_text }}</div>
                        {% endif %}
                        {% if form.is_active.errors %}
                        <div class="validation-feedback invalid-feedback">
                            {{ form.is_active.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <div class="d-flex justify-content-between">
                    <a href="{{ cancel_url }}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-lg me-2"></i>
                        Cancelar
                    </a>
                    <div>
                        <button type="button" class="btn btn-outline-primary me-2" id="preview-btn">
                            <i class="bi bi-eye me-2"></i>
                            Vista Previa
                        </button>
                        <button type="submit" class="btn btn-primary" id="submit-btn">
                            <i class="bi bi-check-lg me-2"></i>
                            {{ submit_text }}
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">
                    <i class="bi bi-eye me-2"></i>
                    Vista Previa del Tipo de Equipo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="preview-content">
                    <!-- Preview content will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('equipment-type-form').submit();">
                    <i class="bi bi-check-lg me-2"></i>
                    {{ submit_text }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('equipment-type-form');
    const typeCodeInput = document.getElementById('{{ form.type_code.id_for_label }}');
    const iconInput = document.getElementById('{{ form.icon.id_for_label }}');
    const colorInput = document.getElementById('{{ form.color.id_for_label }}');
    const attrSchemaInput = document.getElementById('{{ form.attr_schema.id_for_label }}');
    const attrSchemaManualInput = document.getElementById('{{ form.attr_schema.id_for_label }}_manual');
    const iconPreview = document.getElementById('icon-preview');
    const colorPreview = document.getElementById('color-preview');
    
    // Attribute Builder Variables
    let attributeCounter = 0;
    const attributeBuilder = document.getElementById('attribute-builder');
    const addAttributeBtn = document.getElementById('add-attribute');
    const syncJsonBtn = document.getElementById('sync-json-btn');
    
    // Initialize with existing attributes if editing - prioritize hidden field
    if (attrSchemaInput && attrSchemaInput.value.trim()) {
        try {
            const existingSchema = JSON.parse(attrSchemaInput.value);
            console.log('Initializing with existing schema from hidden field:', existingSchema);
            initializeAttributeBuilder(existingSchema);
            // Also sync to manual field
            if (attrSchemaManualInput) {
                attrSchemaManualInput.value = attrSchemaInput.value;
            }
        } catch (e) {
            console.warn('Invalid JSON in attr_schema, trying manual field:', e);
            if (attrSchemaManualInput && attrSchemaManualInput.value.trim()) {
                try {
                    const manualSchema = JSON.parse(attrSchemaManualInput.value);
                    initializeAttributeBuilder(manualSchema);
                } catch (e2) {
                    console.warn('Invalid JSON in manual field too, starting fresh:', e2);
                    initializeAttributeBuilder({});
                }
            } else {
                initializeAttributeBuilder({});
            }
        }
    } else if (attrSchemaManualInput && attrSchemaManualInput.value.trim()) {
        // Try manual field if hidden field is empty
        try {
            const manualSchema = JSON.parse(attrSchemaManualInput.value);
            console.log('Initializing from manual field:', manualSchema);
            initializeAttributeBuilder(manualSchema);
            if (attrSchemaInput) {
                attrSchemaInput.value = attrSchemaManualInput.value;
            }
        } catch (e) {
            console.warn('Invalid JSON in manual field, starting fresh:', e);
            initializeAttributeBuilder({});
        }
    } else {
        console.log('Starting with empty attribute builder');
        initializeAttributeBuilder({});
    }
    
    // Sync JSON button event
    if (syncJsonBtn && attrSchemaManualInput && attrSchemaInput) {
        syncJsonBtn.addEventListener('click', function() {
            const manualValue = attrSchemaManualInput.value.trim();
            if (manualValue) {
                try {
                    const schema = JSON.parse(manualValue);
                    initializeAttributeBuilder(schema);
                    attrSchemaInput.value = manualValue;
                    showSyncIndicator('✓ Esquema sincronizado al constructor visual', 'valid');
                } catch (e) {
                    showSyncIndicator('Error: JSON no válido', 'invalid');
                }
            } else {
                initializeAttributeBuilder({});
                attrSchemaInput.value = '{}';
                showSyncIndicator('✓ Constructor visual limpiado', 'valid');
            }
        });
    }
    
    function showSyncIndicator(message, type) {
        const indicator = document.getElementById('json-sync-indicator');
        if (indicator) {
            indicator.style.display = 'block';
            indicator.className = `validation-feedback ${type === 'valid' ? 'valid-feedback' : 'invalid-feedback'}`;
            indicator.textContent = message;
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }
    }
    
    // Manual JSON editor sync to hidden field
    if (attrSchemaManualInput) {
        attrSchemaManualInput.addEventListener('input', function() {
            if (attrSchemaInput) {
                attrSchemaInput.value = this.value;
            }
        });
    }
    
    // Code availability check
    let codeCheckTimeout;
    if (typeCodeInput) {
        typeCodeInput.addEventListener('input', function() {
            clearTimeout(codeCheckTimeout);
            const code = this.value.trim().toUpperCase();
            const availabilityDiv = document.getElementById('code-availability');
            
            if (code.length >= 3) {
                codeCheckTimeout = setTimeout(() => {
                    checkCodeAvailability(code, availabilityDiv);
                }, 500);
            } else {
                availabilityDiv.style.display = 'none';
            }
        });
    }
    
    // Icon preview
    if (iconInput && iconPreview) {
        iconInput.addEventListener('input', function() {
            const iconClass = this.value.trim();
            if (iconClass) {
                iconPreview.className = `icon-preview ${iconClass}`;
            } else {
                iconPreview.className = 'icon-preview bi bi-gear';
            }
        });
        
        // Initialize icon preview
        const initialIcon = iconInput.value.trim();
        if (initialIcon) {
            iconPreview.className = `icon-preview ${initialIcon}`;
        }
    }
    
    // Color preview
    if (colorInput && colorPreview) {
        colorInput.addEventListener('input', function() {
            const color = this.value;
            if (color) {
                colorPreview.style.backgroundColor = color;
            }
        });
        
        // Initialize color preview
        const initialColor = colorInput.value;
        if (initialColor) {
            colorPreview.style.backgroundColor = initialColor;
        }
    }
    
    // JSON validation
    if (attrSchemaInput) {
        attrSchemaInput.addEventListener('input', function() {
            validateJSON(this.value);
        });
        
        // Initialize JSON validation
        if (attrSchemaInput.value.trim()) {
            validateJSON(attrSchemaInput.value);
        }
    }
    
    // Preview functionality
    const previewBtn = document.getElementById('preview-btn');
    if (previewBtn) {
        previewBtn.addEventListener('click', function() {
            generatePreview();
        });
    }
    
    // Form validation
    form.addEventListener('submit', function(e) {
        // Sync visual builder to hidden JSON field
        syncAttributesToJSON();
        
        if (!validateForm()) {
            e.preventDefault();
        }
    });
    
    // Attribute Builder Functions
    function initializeAttributeBuilder(schema) {
        attributeBuilder.innerHTML = '';
        attributeCounter = 0;
        
        if (Object.keys(schema).length === 0) {
            // Add default attributes for common equipment types
            addAttributeRow('marca', 'Texto', true, 'Marca del equipo');
            addAttributeRow('modelo', 'Texto', true, 'Modelo específico');
        } else {
            // Load existing attributes
            for (const [name, config] of Object.entries(schema)) {
                const typeMap = {
                    'string': 'Texto',
                    'number': 'Número',
                    'boolean': 'Booleano',
                    'date': 'Fecha',
                    'select': 'Selección'
                };
                
                const displayType = typeMap[config.type] || 'Texto';
                const options = config.options ? config.options.join(', ') : '';
                
                addAttributeRow(name, displayType, config.required || false, config.label || name, options);
            }
        }
    }
    
    function addAttributeRow(name = '', type = 'Texto', required = false, label = '', options = '') {
        attributeCounter++;
        const rowId = `attr-row-${attributeCounter}`;
        
        const row = document.createElement('div');
        row.className = 'row g-2 mb-2 align-items-center attribute-row';
        row.id = rowId;
        
        row.innerHTML = `
            <div class="col-md-3">
                <input type="text" class="form-control form-control-sm attribute-name" 
                       placeholder="Nombre del atributo" 
                       value="${name}" 
                       data-row-id="${rowId}">
            </div>
            <div class="col-md-2">
                <select class="form-select form-select-sm attribute-type" 
                        data-row-id="${rowId}">
                    <option value="Texto" ${type === 'Texto' ? 'selected' : ''}>Texto</option>
                    <option value="Número" ${type === 'Número' ? 'selected' : ''}>Número</option>
                    <option value="Booleano" ${type === 'Booleano' ? 'selected' : ''}>Booleano</option>
                    <option value="Fecha" ${type === 'Fecha' ? 'selected' : ''}>Fecha</option>
                    <option value="Selección" ${type === 'Selección' ? 'selected' : ''}>Selección</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control form-control-sm attribute-label" 
                       placeholder="Etiqueta para mostrar" 
                       value="${label}" 
                       data-row-id="${rowId}">
            </div>
            <div class="col-md-2">
                <div class="form-check">
                    <input class="form-check-input attribute-required" 
                           type="checkbox" 
                           id="required-${rowId}" 
                           ${required ? 'checked' : ''}
                           data-row-id="${rowId}">
                    <label class="form-check-label" for="required-${rowId}">
                        Requerido
                    </label>
                </div>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm remove-attribute" 
                        data-row-id="${rowId}">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            <div class="col-md-1 options-field" style="display: ${type === 'Selección' ? 'block' : 'none'};">
                <input type="text" class="form-control form-control-sm attribute-options" 
                       placeholder="Opciones separadas por coma" 
                       value="${options}" 
                       data-row-id="${rowId}">
                <small class="text-muted">Ej: Rojo,Azul,Negro</small>
            </div>
        `;
        
        attributeBuilder.appendChild(row);
        
        // Add event listeners
        const typeSelect = row.querySelector('.attribute-type');
        const removeBtn = row.querySelector('.remove-attribute');
        const nameInput = row.querySelector('.attribute-name');
        const labelInput = row.querySelector('.attribute-label');
        const requiredCheckbox = row.querySelector('.attribute-required');
        const optionsInput = row.querySelector('.attribute-options');
        
        // Listen for changes to sync to JSON
        const syncInputs = [nameInput, typeSelect, labelInput, requiredCheckbox];
        if (optionsInput) syncInputs.push(optionsInput);
        
        syncInputs.forEach(input => {
            if (input) {
                input.addEventListener('change', function() {
                    console.log('Attribute field changed, syncing...');
                    syncAttributesToJSON();
                });
                input.addEventListener('input', function() {
                    console.log('Attribute field input, syncing...');
                    syncAttributesToJSON();
                });
            }
        });
        
        typeSelect.addEventListener('change', function() {
            toggleOptionsField(this.dataset.rowId, this.value);
        });
        
        removeBtn.addEventListener('click', function() {
            removeAttributeRow(this.dataset.rowId);
            console.log('Attribute removed, syncing...');
            syncAttributesToJSON();
        });
    }
    
    function toggleOptionsField(rowId, type) {
        const row = document.getElementById(rowId);
        const optionsField = row.querySelector('.options-field');
        
        if (type === 'Selección') {
            optionsField.style.display = 'block';
        } else {
            optionsField.style.display = 'none';
        }
    }
    
    function removeAttributeRow(rowId) {
        const row = document.getElementById(rowId);
        if (row) {
            row.remove();
        }
    }
    
    function syncAttributesToJSON() {
        const attributes = {};
        const rows = document.querySelectorAll('.attribute-row');
        
        console.log(`Found ${rows.length} attribute rows to sync`);
        
        rows.forEach((row, index) => {
            const nameInput = row.querySelector('.attribute-name');
            const typeSelect = row.querySelector('.attribute-type');
            const labelInput = row.querySelector('.attribute-label');
            const requiredCheckbox = row.querySelector('.attribute-required');
            const optionsInput = row.querySelector('.attribute-options');
            
            const name = nameInput.value.trim();
            if (!name) {
                console.log(`Skipping row ${index + 1}: empty name`);
                return; // Skip empty rows
            }
            
            const typeMap = {
                'Texto': 'string',
                'Número': 'number',
                'Booleano': 'boolean',
                'Fecha': 'date',
                'Selección': 'select'
            };
            
            const config = {
                type: typeMap[typeSelect.value] || 'string',
                required: requiredCheckbox.checked,
                label: labelInput.value.trim() || name
            };
            
            if (typeSelect.value === 'Selección' && optionsInput && optionsInput.value.trim()) {
                config.options = optionsInput.value.split(',').map(opt => opt.trim()).filter(opt => opt);
            }
            
            attributes[name] = config;
            console.log(`Added attribute: ${name}`, config);
        });
        
        // Update hidden JSON field
        if (attrSchemaInput) {
            const jsonString = JSON.stringify(attributes, null, 2);
            attrSchemaInput.value = jsonString;
            console.log('Synced attributes to JSON field:', attributes);
            console.log('JSON string:', jsonString);
        } else {
            console.error('attrSchemaInput not found!');
        }
    }
    
    // Add attribute button event
    if (addAttributeBtn) {
        addAttributeBtn.addEventListener('click', function() {
            addAttributeRow();
        });
    }
    
    // Functions
    function checkCodeAvailability(code, availabilityDiv) {
        const excludeId = '{{ object.type_id|default:"" }}';
        const url = `{% url 'frontend:equipment_type_check_code' %}?code=${encodeURIComponent(code)}&exclude_id=${excludeId}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                availabilityDiv.style.display = 'block';
                if (data.available) {
                    availabilityDiv.className = 'validation-feedback valid-feedback';
                    availabilityDiv.textContent = '✓ Código disponible';
                } else {
                    availabilityDiv.className = 'validation-feedback invalid-feedback';
                    availabilityDiv.textContent = data.message || 'Código no disponible';
                }
            })
            .catch(error => {
                console.error('Error checking code availability:', error);
                availabilityDiv.style.display = 'none';
            });
    }
    
    function validateJSON(jsonString) {
        const validationDiv = document.getElementById('json-validation');
        
        if (!jsonString.trim()) {
            validationDiv.style.display = 'none';
            return true;
        }
        
        try {
            const parsed = JSON.parse(jsonString);
            
            // Validate schema structure
            if (typeof parsed !== 'object' || Array.isArray(parsed)) {
                throw new Error('El esquema debe ser un objeto JSON');
            }
            
            // Validate field definitions
            for (const [fieldName, fieldConfig] of Object.entries(parsed)) {
                if (typeof fieldConfig !== 'object') {
                    throw new Error(`La configuración del campo '${fieldName}' debe ser un objeto`);
                }
                
                if (!fieldConfig.type) {
                    throw new Error(`El campo '${fieldName}' debe especificar un tipo`);
                }
                
                const validTypes = ['string', 'number', 'boolean', 'date', 'select'];
                if (!validTypes.includes(fieldConfig.type)) {
                    throw new Error(`Tipo '${fieldConfig.type}' no válido para el campo '${fieldName}'`);
                }
            }
            
            validationDiv.style.display = 'block';
            validationDiv.className = 'validation-feedback valid-feedback';
            validationDiv.textContent = '✓ JSON válido';
            return true;
            
        } catch (error) {
            validationDiv.style.display = 'block';
            validationDiv.className = 'validation-feedback invalid-feedback';
            validationDiv.textContent = `Error: ${error.message}`;
            return false;
        }
    }
    
    function validateForm() {
        let isValid = true;
        
        // Validate required fields
        const requiredFields = [typeCodeInput, document.getElementById('{{ form.category.id_for_label }}'), document.getElementById('{{ form.name.id_for_label }}')];
        
        requiredFields.forEach(field => {
            if (field && !field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else if (field) {
                field.classList.remove('is-invalid');
            }
        });
        
        // Validate JSON if provided
        if (attrSchemaInput && attrSchemaInput.value.trim()) {
            if (!validateJSON(attrSchemaInput.value)) {
                isValid = false;
            }
        }
        
        return isValid;
    }
    
    function generatePreview() {
        // Sync attributes first
        syncAttributesToJSON();
        
        const formData = new FormData(form);
        const previewContent = document.getElementById('preview-content');
        
        const typeCode = formData.get('type_code') || 'N/A';
        const category = formData.get('category') || 'N/A';
        const name = formData.get('name') || 'Sin nombre';
        const description = formData.get('description') || 'Sin descripción';
        const icon = formData.get('icon') || 'bi bi-gear';
        const color = formData.get('color') || '#007bff';
        const isActive = formData.get('is_active') === 'on';
        
        let attrSchema = {};
        try {
            if (formData.get('attr_schema')) {
                attrSchema = JSON.parse(formData.get('attr_schema'));
            }
        } catch (e) {
            // Invalid JSON, ignore
        }
        
        previewContent.innerHTML = `
            <div class="card">
                <div class="card-header" style="background-color: ${color}; color: white;">
                    <div class="d-flex align-items-center">
                        <i class="${icon} me-3" style="font-size: 2rem;"></i>
                        <div>
                            <h5 class="mb-0">${name}</h5>
                            <small class="opacity-75">Código: ${typeCode}</small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Categoría:</strong> ${category}
                        </div>
                        <div class="col-md-6">
                            <strong>Estado:</strong> 
                            <span class="badge bg-${isActive ? 'success' : 'danger'}">
                                ${isActive ? 'Activo' : 'Inactivo'}
                            </span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong>Descripción:</strong>
                        <p class="mb-0">${description}</p>
                    </div>
                    ${Object.keys(attrSchema).length > 0 ? `
                    <div>
                        <strong>Atributos definidos:</strong>
                        <ul class="list-unstyled mt-2">
                            ${Object.entries(attrSchema).map(([key, config]) => `
                                <li class="mb-1">
                                    <span class="badge bg-light text-dark">${key}</span>
                                    <small class="text-muted ms-2">${config.type}${config.required ? ' (requerido)' : ''}</small>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        modal.show();
    }
});
</script>
{% endblock %}