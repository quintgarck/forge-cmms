{% extends 'frontend/base/base.html' %}
{% load static %}

{% block title %}{{ system.name_es }} - Sistema de Taxonomía - MovIAx{% endblock %}

{% block body_class %}catalog-page{% endblock %}

{% block extra_css %}
<link href="{% static 'frontend/css/taxonomy-system-detail.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            {% for breadcrumb in breadcrumbs %}
                {% if breadcrumb.url %}
                    <li class="breadcrumb-item">
                        <a href="{{ breadcrumb.url }}">{{ breadcrumb.name }}</a>
                    </li>
                {% else %}
                    <li class="breadcrumb-item active" aria-current="page">
                        {{ breadcrumb.name }}
                    </li>
                {% endif %}
            {% endfor %}
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 class="h3 mb-2">
                <i class="bi bi-diagram-2 text-primary"></i>
                {{ system.name_es }}
                <span class="badge bg-primary ms-2">{{ system.system_code }}</span>
                {% if not system.is_active %}
                    <span class="badge bg-warning ms-1">Inactivo</span>
                {% endif %}
            </h1>
            {% if system.scope %}
                <p class="text-muted mb-0">{{ system.scope }}</p>
            {% endif %}
        </div>
        
        <div class="btn-group" role="group">
            <a href="{% url 'frontend:taxonomy_system_edit' system.system_code %}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Editar
            </a>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-gear"></i> Acciones
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{% url 'frontend:taxonomy_tree' %}">
                        <i class="bi bi-diagram-3"></i> Ver en Árbol
                    </a></li>
                    <li><a class="dropdown-item" href="#" data-action="add-subsystem">
                        <i class="bi bi-plus-circle"></i> Agregar Subsistema
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="{% url 'frontend:taxonomy_system_delete' system.system_code %}">
                        <i class="bi bi-trash"></i> Eliminar Sistema
                    </a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Información principal -->
        <div class="col-lg-8">
            <!-- Estadísticas del sistema -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-success text-white h-100">
                        <div class="card-body text-center d-flex flex-column justify-content-center">
                            <i class="bi bi-diagram-3" style="font-size: 2rem;"></i>
                            <h4 class="mt-2">{{ system_stats.subsystems_count|default:0 }}</h4>
                            <p class="mb-0">Subsistemas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-info text-white h-100">
                        <div class="card-body text-center d-flex flex-column justify-content-center">
                            <i class="bi bi-collection" style="font-size: 2rem;"></i>
                            <h4 class="mt-2">{{ system_stats.groups_count|default:0 }}</h4>
                            <p class="mb-0">Grupos</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning text-dark h-100">
                        <div class="card-body text-center d-flex flex-column justify-content-center">
                            <i class="bi bi-nodes" style="font-size: 2rem;"></i>
                            <h4 class="mt-2">{{ system_stats.total_items|default:0 }}</h4>
                            <p class="mb-0">Total Items</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subsistemas -->
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-diagram-3"></i> Subsistemas
                    </h5>
                    <button type="button" class="btn btn-primary btn-sm" data-action="add-subsystem">
                        <i class="bi bi-plus"></i> Agregar Subsistema
                    </button>
                </div>
                
                {% if subsystems %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Código</th>
                                    <th>Nombre</th>
                                    <th>Descripción</th>
                                    <th>Grupos</th>
                                    <th>Estado</th>
                                    <th>Orden</th>
                                    <th width="120">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for subsystem in subsystems %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-success">{{ subsystem.subsystem_code }}</span>
                                        </td>
                                        <td>
                                            <strong>{{ subsystem.name_es }}</strong>
                                        </td>
                                        <td>
                                            <span class="text-muted">
                                                {{ subsystem.notes|default:"Sin descripción"|truncatechars:40 }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">
                                                {{ subsystem.groups|length|default:0 }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if subsystem.is_active %}
                                                <span class="badge bg-success">
                                                    <i class="bi bi-check-circle"></i> Activo
                                                </span>
                                            {% else %}
                                                <span class="badge bg-warning">
                                                    <i class="bi bi-pause-circle"></i> Inactivo
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="text-muted">{{ subsystem.sort_order|default:0 }}</span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a href="{% url 'frontend:taxonomy_subsystem_detail' system.system_code subsystem.subsystem_code %}" 
                                                   class="btn btn-outline-info" title="Ver detalles">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <a href="{% url 'frontend:taxonomy_subsystem_edit' system.system_code subsystem.subsystem_code %}" 
                                                   class="btn btn-outline-primary" title="Editar">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <a href="{% url 'frontend:taxonomy_group_create' subsystem.subsystem_code %}" 
                                                   class="btn btn-outline-success" title="Agregar grupo">
                                                    <i class="bi bi-plus"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="card-body text-center py-5">
                        <i class="bi bi-diagram-3 text-muted" style="font-size: 3rem;"></i>
                        <h5 class="text-muted mt-3">No hay subsistemas</h5>
                        <p class="text-muted">Comience agregando el primer subsistema a este sistema</p>
                        <button type="button" class="btn btn-primary" data-action="add-subsystem">
                            <i class="bi bi-plus-circle"></i> Agregar Primer Subsistema
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Panel lateral -->
        <div class="col-lg-4">
            <!-- Información del sistema -->
            <div class="card mb-3 sidebar-card">
                <div class="card-header card-header-compact">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle"></i> Información del Sistema
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-sm-5"><strong>ID:</strong></div>
                        <div class="col-sm-7">{{ system.system_code }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-5"><strong>Código:</strong></div>
                        <div class="col-sm-7">
                            <span class="badge bg-primary">{{ system.system_code }}</span>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-5"><strong>Estado:</strong></div>
                        <div class="col-sm-7">
                            {% if system.is_active %}
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle"></i> Activo
                                </span>
                            {% else %}
                                <span class="badge bg-warning">
                                    <i class="bi bi-pause-circle"></i> Inactivo
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    {% if system.created_at %}
                        <div class="row mb-2">
                            <div class="col-sm-5"><strong>Creado:</strong></div>
                            <div class="col-sm-7">
                                <small>{{ system.created_at|date:"d/m/Y H:i" }}</small>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Navegación rápida -->
            <div class="card mb-3 sidebar-card">
                <div class="card-header card-header-compact">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-compass"></i> Navegación Rápida
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'frontend:taxonomy_tree' %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-diagram-3"></i> Ver Árbol Completo
                        </a>
                        <a href="{% url 'frontend:taxonomy_system_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-list"></i> Lista de Sistemas
                        </a>
                        <button type="button" class="btn btn-outline-success btn-sm" data-action="add-subsystem">
                            <i class="bi bi-plus"></i> Nuevo Subsistema
                        </button>
                        <hr>
                        <a href="{% url 'frontend:taxonomy_system_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-left"></i> Volver a Sistemas
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Actividad reciente -->
            {% if system_stats.recent_activity %}
                <div class="card sidebar-card">
                    <div class="card-header card-header-compact">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-clock-history"></i> Actividad Reciente
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            {% for activity in system_stats.recent_activity %}
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-{{ activity.type|default:'secondary' }}"></div>
                                    <div class="timeline-content">
                                        <h6 class="timeline-title">{{ activity.title }}</h6>
                                        <p class="timeline-description">{{ activity.description }}</p>
                                        <small class="text-muted">{{ activity.timestamp|date:"d/m/Y H:i" }}</small>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal para agregar subsistema -->
<div class="modal fade" id="addSubsystemModal" tabindex="-1" aria-labelledby="addSubsystemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="pointer-events: auto;">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Agregar Subsistema
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="add-subsystem-form">
                {% csrf_token %}
                <input type="hidden" name="system" value="{{ system.system_code }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="subsystem-code" class="form-label">Código <span class="text-danger">*</span></label>
                        <input type="text" class="form-control text-uppercase" id="subsystem-code" 
                               name="code" required maxlength="20" placeholder="Ej: ENGINE_BLOCK">
                    </div>
                    <div class="mb-3">
                        <label for="subsystem-name" class="form-label">Nombre <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="subsystem-name" 
                               name="name" required maxlength="100" placeholder="Ej: Bloque del Motor">
                    </div>
                    <div class="mb-3">
                        <label for="subsystem-description" class="form-label">Descripción</label>
                        <textarea class="form-control" id="subsystem-description" name="description" 
                                  rows="3" maxlength="500" placeholder="Descripción opcional del subsistema"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subsystem-order" class="form-label">Orden</label>
                                <input type="number" class="form-control" id="subsystem-order" 
                                       name="sort_order" min="0" max="999" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="subsystem-active" 
                                           name="is_active" checked>
                                    <label class="form-check-label" for="subsystem-active">
                                        Activo
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check"></i> Crear Subsistema
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejar acciones de botones
    document.addEventListener('click', function(e) {
        const action = e.target.dataset.action || e.target.closest('[data-action]')?.dataset.action;
        
        switch (action) {
            case 'add-subsystem':
                showAddSubsystemModal();
                break;
            case 'view-subsystem':
                viewSubsystem(e.target.dataset.subsystemId);
                break;
            case 'edit-subsystem':
                editSubsystem(e.target.dataset.subsystemId);
                break;
            case 'add-group':
                addGroup(e.target.dataset.subsystemId);
                break;
        }
    });
    
    // Mostrar modal para agregar subsistema
    function showAddSubsystemModal() {
        console.log('Showing add subsystem modal...');
        const modalElement = document.getElementById('addSubsystemModal');
        if (!modalElement) {
            console.error('Modal element not found!');
            alert('Error: No se encontró el modal');
            return;
        }
        
        try {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            console.log('Modal shown successfully');
        } catch (error) {
            console.error('Error showing modal:', error);
            alert('Error al mostrar el modal: ' + error.message);
        }
    }
    
    // Manejar envío del formulario de subsistema
    document.getElementById('add-subsystem-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('{% url "frontend:taxonomy_subsystem_create" system.system_code %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al crear el subsistema');
        });
    });
    
    // Funciones de acción
    function viewSubsystem(subsystemId) {
        window.location.href = `/catalog/taxonomy/subsystems/${subsystemId}/`;
    }
    
    function editSubsystem(subsystemId) {
        window.location.href = `/catalog/taxonomy/subsystems/${subsystemId}/edit/`;
    }
    
    function addGroup(subsystemId) {
        window.location.href = `/catalog/taxonomy/groups/create/?subsystem=${subsystemId}`;
    }
    
    
    // Validación en tiempo real del código
    document.getElementById('subsystem-code').addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });
});
</script>
{% endblock %}