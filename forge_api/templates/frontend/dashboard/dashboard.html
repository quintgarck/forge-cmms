{% extends 'frontend/base/base.html' %}
{% load static %}

{% block title %}Dashboard - MovIAx{% endblock %}
{% block body_class %}dashboard-page{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                     style="width: 50px; height: 50px;">
                    <i class="bi bi-speedometer2" style="font-size: 1.25rem;"></i>
                </div>
            </div>
            <div class="flex-grow-1 ms-3">
                <h1 class="h3 mb-0">Dashboard</h1>
                <p class="text-muted mb-0">
                    Bienvenido, {{ user.get_full_name|default:user.username }}
                    <span class="mx-2">•</span>
                    <span id="current-time"></span>
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4 text-md-end">
        <div class="btn-group" role="group">
            <button class="btn btn-outline-primary" onclick="refreshDashboard()" id="refresh-btn">
                <i class="bi bi-arrow-clockwise me-1"></i>
                Actualizar
            </button>
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-gear me-1"></i>
                Opciones
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" onclick="exportDashboard()">
                    <i class="bi bi-download me-2"></i>Exportar Datos
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="printDashboard()">
                    <i class="bi bi-printer me-2"></i>Imprimir
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="toggleAutoRefresh()">
                    <i class="bi bi-arrow-repeat me-2"></i>
                    <span id="auto-refresh-text">Activar Auto-actualización</span>
                </a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Enhanced KPI Cards Row -->
<div class="row mb-4" id="kpi-cards">
    <!-- First Row - Core KPIs -->
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card dashboard-card kpi-primary h-100" data-kpi-drilldown="workorders">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Órdenes Activas</h6>
                        <h2 class="card-text text-primary mb-1" id="active-workorders">
                            {{ active_work_orders|default:0 }}
                        </h2>
                        <small class="text-muted">
                            {% if workorders_trend > 0 %}
                                <i class="bi bi-arrow-up text-success me-1"></i>
                                <span id="workorders-trend">+{{ workorders_trend }}% vs período anterior</span>
                            {% elif workorders_trend < 0 %}
                                <i class="bi bi-arrow-down text-danger me-1"></i>
                                <span id="workorders-trend">{{ workorders_trend }}% vs período anterior</span>
                            {% else %}
                                <i class="bi bi-dash text-muted me-1"></i>
                                <span id="workorders-trend">Sin cambios</span>
                            {% endif %}
                        </small>
                    </div>
                    <div class="text-primary opacity-75">
                        <i class="bi bi-clipboard-check" style="font-size: 2.5rem;"></i>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-primary" style="width: {% if active_work_orders > 0 %}75{% else %}0{% endif %}%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card dashboard-card kpi-warning h-100" data-kpi-drilldown="invoices">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Facturas Pendientes</h6>
                        <h2 class="card-text text-warning mb-1" id="pending-invoices">
                            {{ pending_invoices|default:0 }}
                        </h2>
                        <small class="text-muted">
                            {% if overdue_invoices > 0 %}
                                <i class="bi bi-exclamation-triangle text-danger me-1"></i>
                                <span id="invoices-trend">{{ overdue_invoices }} vencidas</span>
                            {% else %}
                                <i class="bi bi-check-circle text-success me-1"></i>
                                <span id="invoices-trend">Todas al día</span>
                            {% endif %}
                        </small>
                    </div>
                    <div class="text-warning opacity-75">
                        <i class="bi bi-receipt" style="font-size: 2.5rem;"></i>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-warning" style="width: {% if pending_invoices > 0 %}45{% else %}0{% endif %}%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card dashboard-card kpi-danger h-100" data-kpi-drilldown="inventory">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Stock Bajo</h6>
                        <h2 class="card-text text-danger mb-1" id="low-stock-items">
                            {{ low_stock_items|default:0 }}
                        </h2>
                        <small class="text-muted">
                            {% if critical_stock > 0 %}
                                <i class="bi bi-exclamation-triangle text-danger me-1"></i>
                                <span id="stock-trend">{{ critical_stock }} críticos</span>
                            {% else %}
                                <i class="bi bi-check-circle text-success me-1"></i>
                                <span id="stock-trend">Niveles normales</span>
                            {% endif %}
                        </small>
                    </div>
                    <div class="text-danger opacity-75">
                        <i class="bi bi-exclamation-triangle" style="font-size: 2.5rem;"></i>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-danger" style="width: {% if low_stock_items > 0 %}25{% else %}0{% endif %}%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card dashboard-card kpi-success h-100" data-kpi-drilldown="productivity">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Productividad</h6>
                        <h2 class="card-text text-success mb-1" id="technician-productivity">
                            {{ technician_productivity|default:0 }}%
                        </h2>
                        <small class="text-muted">
                            {% if avg_completion_days > 0 %}
                                <i class="bi bi-clock text-info me-1"></i>
                                <span id="productivity-trend">{{ avg_completion_days }} días promedio</span>
                            {% else %}
                                <i class="bi bi-dash text-muted me-1"></i>
                                <span id="productivity-trend">Sin datos</span>
                            {% endif %}
                        </small>
                    </div>
                    <div class="text-success opacity-75">
                        <i class="bi bi-graph-up" style="font-size: 2.5rem;"></i>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-success" style="width: {{ technician_productivity|default:0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Second Row - Extended KPIs -->
<div class="row mb-4" id="extended-kpi-cards">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card dashboard-card kpi-info h-100" data-kpi-drilldown="suppliers">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Órdenes de Compra</h6>
                        <h2 class="card-text text-info mb-1" id="active-purchase-orders">
                            {{ active_purchase_orders|default:0 }}
                        </h2>
                        <small class="text-muted">
                            <i class="bi bi-truck text-info me-1"></i>
                            <span id="po-trend">{{ pending_deliveries|default:0 }} pendientes</span>
                        </small>
                    </div>
                    <div class="text-info opacity-75">
                        <i class="bi bi-cart" style="font-size: 2.5rem;"></i>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-info" style="width: {% if active_purchase_orders > 0 %}60{% else %}0{% endif %}%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card dashboard-card kpi-secondary h-100" data-kpi-drilldown="oem">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Catálogo OEM</h6>
                        <h2 class="card-text text-secondary mb-1" id="oem-parts-count">
                            {{ oem_parts_count|default:0 }}
                        </h2>
                        <small class="text-muted">
                            <i class="bi bi-diagram-3 text-secondary me-1"></i>
                            <span id="oem-trend">{{ oem_brands_count|default:0 }} marcas</span>
                        </small>
                    </div>
                    <div class="text-secondary opacity-75">
                        <i class="bi bi-diagram-3" style="font-size: 2.5rem;"></i>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-secondary" style="width: {% if oem_parts_count > 0 %}80{% else %}0{% endif %}%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card dashboard-card kpi-dark h-100" data-kpi-drilldown="alerts">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Alertas Activas</h6>
                        <h2 class="card-text text-dark mb-1" id="active-alerts-count">
                            {{ alert_count|default:0 }}
                        </h2>
                        <small class="text-muted">
                            {% if critical_alerts > 0 %}
                                <i class="bi bi-exclamation-triangle text-danger me-1"></i>
                                <span id="alerts-trend">{{ critical_alerts }} críticas</span>
                            {% else %}
                                <i class="bi bi-check-circle text-success me-1"></i>
                                <span id="alerts-trend">Sistema estable</span>
                            {% endif %}
                        </small>
                    </div>
                    <div class="text-dark opacity-75">
                        <i class="bi bi-bell" style="font-size: 2.5rem;"></i>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-dark" style="width: {% if alert_count > 0 %}30{% else %}0{% endif %}%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card dashboard-card kpi-purple h-100" data-kpi-drilldown="compliance">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Compliance Score</h6>
                        <h2 class="card-text text-purple mb-1" id="compliance-score">
                            {{ compliance_score|default:0 }}%
                        </h2>
                        <small class="text-muted">
                            <i class="bi bi-shield-check text-success me-1"></i>
                            <span id="compliance-trend">{{ audit_entries|default:0 }} registros</span>
                        </small>
                    </div>
                    <div class="text-purple opacity-75">
                        <i class="bi bi-shield-check" style="font-size: 2.5rem;"></i>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-purple" style="width: {{ compliance_score|default:0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Analytics Row -->
<div class="row mb-4">
    <!-- Main Chart -->
    <div class="col-xl-8 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart me-2"></i>
                        Órdenes de Trabajo - Últimos 7 días
                    </h5>
                    <small class="text-muted">Tendencia de órdenes creadas y completadas</small>
                </div>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="chart-period" id="period-7d" checked>
                    <label class="btn btn-outline-primary" for="period-7d">7D</label>
                    
                    <input type="radio" class="btn-check" name="chart-period" id="period-30d">
                    <label class="btn btn-outline-primary" for="period-30d">30D</label>
                    
                    <input type="radio" class="btn-check" name="chart-period" id="period-90d">
                    <label class="btn btn-outline-primary" for="period-90d">90D</label>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 350px;">
                    <canvas id="workordersChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Distribution -->
    <div class="col-xl-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pie-chart me-2"></i>
                    Estado de Órdenes
                </h5>
                <small class="text-muted">Distribución actual</small>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 250px;">
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="d-flex align-items-center">
                            <span class="badge bg-warning me-2"></span>
                            Pendientes
                        </span>
                        <span class="fw-bold" id="status-pending">30</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="d-flex align-items-center">
                            <span class="badge bg-info me-2"></span>
                            En Progreso
                        </span>
                        <span class="fw-bold" id="status-progress">45</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="d-flex align-items-center">
                            <span class="badge bg-success me-2"></span>
                            Completadas
                        </span>
                        <span class="fw-bold" id="status-completed">20</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="d-flex align-items-center">
                            <span class="badge bg-danger me-2"></span>
                            Canceladas
                        </span>
                        <span class="fw-bold" id="status-cancelled">5</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Charts Row -->
<div class="row mb-4">
    <!-- Revenue Trend -->
    <div class="col-xl-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up me-2"></i>
                        Tendencia de Ingresos
                    </h5>
                    <small class="text-muted">Últimos 30 días</small>
                </div>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="window.dashboardCharts?.exportChart('revenue')">
                            <i class="bi bi-download me-2"></i>Exportar
                        </a></li>
                        <li><a class="dropdown-item" href="/reports/revenue/">
                            <i class="bi bi-file-text me-2"></i>Ver Reporte
                        </a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Productivity Radar -->
    <div class="col-xl-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Métricas de Productividad
                </h5>
                <small class="text-muted">Comparación mensual</small>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="productivityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Row: Alerts and Activity -->
<div class="row">
    <!-- System Alerts -->
    <div class="col-xl-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        Alertas del Sistema
                    </h5>
                    <small class="text-muted">Notificaciones importantes</small>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshAlerts()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body">
                <div id="system-alerts">
                    {% if recent_alerts %}
                        {% for alert in recent_alerts %}
                            <div class="alert alert-{{ alert.severity|default:'info' }} alert-dismissible fade show mb-2" role="alert">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0 me-2">
                                        {% if alert.severity == 'danger' %}
                                            <i class="bi bi-exclamation-triangle-fill"></i>
                                        {% elif alert.severity == 'warning' %}
                                            <i class="bi bi-exclamation-circle-fill"></i>
                                        {% else %}
                                            <i class="bi bi-info-circle-fill"></i>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1">
                                        <strong>{{ alert.title|default:'Sistema' }}</strong>
                                        <p class="mb-1">{{ alert.message|default:'Sin mensaje' }}</p>
                                        <small class="text-muted">
                                            {% if alert.created_at %}
                                                {{ alert.created_at|date:"d/m/Y H:i" }}
                                            {% else %}
                                                Fecha no disponible
                                            {% endif %}
                                        </small>
                                    </div>
                                    <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="alert"></button>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-check-circle display-4 text-success opacity-50"></i>
                            <h6 class="mt-3 text-muted">No hay alertas activas</h6>
                            <p class="text-muted small">El sistema está funcionando correctamente</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="col-xl-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        Actividad Reciente
                    </h5>
                    <small class="text-muted">Últimas acciones del sistema</small>
                </div>
                <a href="#" class="btn btn-sm btn-outline-primary">Ver Todo</a>
            </div>
            <div class="card-body">
                <div id="recent-activity">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success">
                                <i class="bi bi-plus-circle text-white"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Nueva orden de trabajo creada</h6>
                                <p class="text-muted small mb-1">Orden #1234 - Cliente: Juan Pérez</p>
                                <small class="text-muted">Hace 15 minutos</small>
                            </div>
                        </div>
                        
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary">
                                <i class="bi bi-check-circle text-white"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Orden completada</h6>
                                <p class="text-muted small mb-1">Orden #1230 - Cambio de aceite</p>
                                <small class="text-muted">Hace 1 hora</small>
                            </div>
                        </div>
                        
                        <div class="timeline-item">
                            <div class="timeline-marker bg-info">
                                <i class="bi bi-person-plus text-white"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Nuevo cliente registrado</h6>
                                <p class="text-muted small mb-1">María González - Contacto: 555-0123</p>
                                <small class="text-muted">Hace 2 horas</small>
                            </div>
                        </div>
                        
                        <div class="timeline-item">
                            <div class="timeline-marker bg-warning">
                                <i class="bi bi-exclamation-triangle text-white"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Stock bajo detectado</h6>
                                <p class="text-muted small mb-1">Filtro de aceite - Quedan 5 unidades</p>
                                <small class="text-muted">Hace 3 horas</small>
                            </div>
                        </div>
                        
                        <div class="timeline-item">
                            <div class="timeline-marker bg-secondary">
                                <i class="bi bi-gear text-white"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Mantenimiento programado</h6>
                                <p class="text-muted small mb-1">Equipo de diagnóstico - Próximo: 05/01/2025</p>
                                <small class="text-muted">Hace 4 horas</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Floating Button -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1000;">
    <div class="dropup">
        <button class="btn btn-primary btn-lg rounded-circle shadow" type="button" 
                data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-plus-lg"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end mb-2">
            <li><a class="dropdown-item" href="{% url 'frontend:client_create' %}">
                <i class="bi bi-person-plus me-2"></i>Nuevo Cliente
            </a></li>
            <li><a class="dropdown-item" href="{% url 'frontend:workorder_create' %}">
                <i class="bi bi-clipboard-plus me-2"></i>Nueva Orden
            </a></li>
            <li><a class="dropdown-item" href="{% url 'frontend:product_create' %}">
                <i class="bi bi-box-seam me-2"></i>Nuevo Producto
            </a></li>
            <li><a class="dropdown-item" href="{% url 'frontend:equipment_create' %}">
                <i class="bi bi-tools me-2"></i>Registrar Equipo
            </a></li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Dashboard specific styles */
.dashboard-page .dashboard-card {
    transition: all 0.3s ease;
}

.dashboard-page .dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

/* Extended KPI color classes */
.text-purple {
    color: #6f42c1 !important;
}

.bg-purple {
    background-color: #6f42c1 !important;
}

.kpi-purple .card-body {
    border-left: 4px solid #6f42c1;
}

.kpi-dark .card-body {
    border-left: 4px solid #212529;
}

.kpi-info .card-body {
    border-left: 4px solid #0dcaf0;
}

.kpi-secondary .card-body {
    border-left: 4px solid #6c757d;
}

.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -22px;
    top: 0;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid #dee2e6;
}

.chart-container canvas {
    max-height: 100% !important;
}

/* Animation for KPI cards */
@keyframes countUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.kpi-card-animate {
    animation: countUp 0.6s ease-out;
}

/* Notification System Styles */
.notification-dropdown {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.notification-item {
    transition: background-color 0.2s ease;
    cursor: pointer;
}

.notification-item:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.notification-unread {
    background-color: rgba(13, 110, 253, 0.05);
    border-left: 3px solid #0d6efd;
}

.notification-unread .notification-title {
    color: #0d6efd;
}

.notification-icon {
    font-size: 0.8rem;
}

.notification-content {
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.notification-content:last-child {
    border-bottom: none;
}

.notification-dismiss {
    opacity: 0;
    transition: opacity 0.2s ease;
}

.notification-item:hover .notification-dismiss {
    opacity: 1;
}

.notification-actions .btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

/* Toast Notifications */
.toast-container {
    z-index: 1055;
}

.toast {
    min-width: 300px;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.toast .toast-body {
    padding: 0.75rem;
}

/* Notification Badge Animation */
#notification-badge {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1);
    }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .dashboard-page .card-text {
        font-size: 1.5rem;
    }
    
    .timeline {
        padding-left: 20px;
    }
    
    .timeline-marker {
        left: -15px;
        width: 24px;
        height: 24px;
        font-size: 0.7rem;
    }
    
    .notification-dropdown {
        width: 100vw !important;
        max-width: 100vw !important;
        left: 0 !important;
        right: 0 !important;
        transform: none !important;
        margin: 0;
        border-radius: 0;
    }
    
    .toast {
        min-width: 280px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Load Chart.js before dashboard-charts.js -->
<script src="{% static 'frontend/vendor/chart.min.js' %}"></script>
<script src="{% static 'frontend/js/dashboard-charts.js' %}"></script>
<script>
// Dashboard JavaScript
let autoRefreshInterval;
let isAutoRefreshEnabled = false;

document.addEventListener('DOMContentLoaded', function() {
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    
    // Initialize chart period buttons
    document.querySelectorAll('input[name="chart-period"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateChartPeriod(this.id.replace('period-', ''));
        });
    });
    
    // Add KPI drill-down functionality
    document.querySelectorAll('[data-kpi-drilldown]').forEach(card => {
        card.addEventListener('click', function() {
            const kpiType = this.dataset.kpiDrilldown;
            showKPIDetails(kpiType);
        });
    });
    
    // Load dashboard data from Django proxy endpoint and update charts
    fetch('/api/dashboard-data/', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': MovIAx.api.getCSRFToken()
        },
        credentials: 'include'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Update KPIs
            updateKPIs(data);
            // Update charts with real data
            updateCharts(data);
            // Update alerts
            if (data.recent_alerts) {
                updateAlerts(data.recent_alerts);
            }
        })
        .catch(error => {
            console.error('Error loading dashboard data:', error);
            MovIAx.utils.showToast('Error al cargar los datos del dashboard', 'warning');
        });
});

function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleString('es-ES', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    const timeElement = document.getElementById('current-time');
    if (timeElement) {
        timeElement.textContent = timeString;
    }
}

function updateStatusCounts(data) {
    // Update status counts in the status distribution legend
    if (data.charts && data.charts.status_distribution) {
        const labels = data.charts.status_distribution.labels;
        const counts = data.charts.status_distribution.data;
        
        labels.forEach((label, index) => {
            const elementId = getStatusElementId(label);
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = counts[index] || 0;
            }
        });
    }
}

function getStatusElementId(statusLabel) {
    const statusMap = {
        'Pendientes': 'status-pending',
        'En Progreso': 'status-progress',
        'Completadas': 'status-completed',
        'Canceladas': 'status-cancelled'
    };
    return statusMap[statusLabel] || 'status-unknown';
}

function updateCharts(data) {
    // Update charts with new data using the DashboardCharts class
    if (window.dashboardCharts && data.charts) {
        window.dashboardCharts.updateAllCharts(data);
        updateStatusCounts(data);
    }
}

function updateChartPeriod(period) {
    console.log('Updating chart period to:', period);
    
    // Fetch data for the selected period from Django proxy endpoint
    const params = new URLSearchParams({ period: period });
    
    fetch(`/api/dashboard-data/?${params}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': MovIAx.api.getCSRFToken()
        },
        credentials: 'include'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            updateCharts(data);
            MovIAx.utils.showToast(`Período actualizado a ${period}`, 'info');
        })
        .catch(error => {
            console.error('Error updating chart period:', error);
            MovIAx.utils.showToast('Error al actualizar período', 'danger');
        });
}

function refreshDashboard() {
    const button = document.getElementById('refresh-btn');
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Actualizando...';
    
    // Fetch updated dashboard data from Django proxy endpoint
    fetch('/api/dashboard-data/', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': MovIAx.api.getCSRFToken()
        },
        credentials: 'include'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            updateKPIs(data);
            updateCharts(data);
            updateAlerts(data.recent_alerts);
            MovIAx.utils.showToast('Dashboard actualizado exitosamente', 'success');
        })
        .catch(error => {
            console.error('Dashboard refresh error:', error);
            MovIAx.utils.showToast('Error al actualizar dashboard', 'danger');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = originalText;
        });
}

function updateKPIs(data) {
    // Animate KPI updates
    const kpiCards = document.querySelectorAll('#kpi-cards .card');
    kpiCards.forEach(card => card.classList.add('kpi-card-animate'));
    
    // Update values with animation
    animateValue('active-workorders', data.active_work_orders || 0);
    animateValue('pending-invoices', data.pending_invoices || 0);
    animateValue('low-stock-items', data.low_stock_items || 0);
    animateValue('technician-productivity', data.technician_productivity || 0, '%');
    
    // Update trend indicators
    updateTrendIndicator('workorders-trend', data.workorders_trend, 'vs período anterior');
    updateTrendIndicator('invoices-trend', data.overdue_invoices, 'vencidas', 'count');
    updateTrendIndicator('stock-trend', data.critical_stock, 'críticos', 'count');
    updateTrendIndicator('productivity-trend', data.avg_completion_days, 'días promedio', 'days');
    
    // Remove animation class after animation completes
    setTimeout(() => {
        kpiCards.forEach(card => card.classList.remove('kpi-card-animate'));
    }, 600);
}

function animateValue(elementId, targetValue, suffix = '') {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const startValue = parseInt(element.textContent) || 0;
    const duration = 1000;
    const startTime = performance.now();
    
    function animate(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const currentValue = Math.round(startValue + (targetValue - startValue) * easeOut);
        
        element.textContent = currentValue + suffix;
        
        if (progress < 1) {
            requestAnimationFrame(animate);
        }
    }
    
    requestAnimationFrame(animate);
}

function updateTrendIndicator(elementId, value, suffix, type = 'percentage') {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    let icon = 'dash';
    let colorClass = 'text-muted';
    let displayText = '';
    
    if (type === 'percentage') {
        if (value > 0) {
            icon = 'arrow-up';
            colorClass = 'text-success';
            displayText = `+${value}% ${suffix}`;
        } else if (value < 0) {
            icon = 'arrow-down';
            colorClass = 'text-danger';
            displayText = `${value}% ${suffix}`;
        } else {
            displayText = 'Sin cambios';
        }
    } else if (type === 'count') {
        if (value > 0) {
            icon = 'exclamation-triangle';
            colorClass = 'text-danger';
            displayText = `${value} ${suffix}`;
        } else {
            icon = 'check-circle';
            colorClass = 'text-success';
            displayText = suffix === 'vencidas' ? 'Todas al día' : 'Niveles normales';
        }
    } else if (type === 'days') {
        icon = 'clock';
        colorClass = 'text-info';
        displayText = value > 0 ? `${value} ${suffix}` : 'Sin datos';
    }
    
    element.innerHTML = `<i class="bi bi-${icon} ${colorClass} me-1"></i><span>${displayText}</span>`;
}

function updateCharts(data) {
    // Update charts with new data
    if (data.charts) {
        // Update work orders chart
        if (window.workordersChart && data.charts.workorders_week) {
            window.workordersChart.data.labels = data.charts.workorders_week.labels;
            window.workordersChart.data.datasets[0].data = data.charts.workorders_week.created;
            if (data.charts.workorders_week.completed) {
                window.workordersChart.data.datasets[1].data = data.charts.workorders_week.completed;
            }
            window.workordersChart.update('none');
        }
        
        // Update status chart
        if (window.statusChart && data.charts.status_distribution) {
            window.statusChart.data.labels = data.charts.status_distribution.labels;
            window.statusChart.data.datasets[0].data = data.charts.status_distribution.data;
            window.statusChart.update('none');
        }
    }
}

function updateAlerts(alerts) {
    const alertsContainer = document.getElementById('system-alerts');
    if (!alertsContainer) return;
    
    if (!alerts || alerts.length === 0) {
        alertsContainer.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-check-circle display-4 text-success opacity-50"></i>
                <h6 class="mt-3 text-muted">No hay alertas activas</h6>
                <p class="text-muted small">El sistema está funcionando correctamente</p>
            </div>
        `;
        return;
    }
    
    const alertsHTML = alerts.map(alert => {
        const severity = alert.severity || 'info';
        const icon = getAlertIcon(severity);
        const title = alert.title || 'Sistema';
        const message = alert.message || 'Sin mensaje';
        const createdAt = alert.created_at ? new Date(alert.created_at).toLocaleString('es-MX') : 'Fecha no disponible';
        
        return `
            <div class="alert alert-${severity} alert-dismissible fade show mb-2" role="alert">
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 me-2">
                        <i class="bi bi-${icon}-fill"></i>
                    </div>
                    <div class="flex-grow-1">
                        <strong>${title}</strong>
                        <p class="mb-1">${message}</p>
                        <small class="text-muted">${createdAt}</small>
                    </div>
                    <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="alert"></button>
                </div>
            </div>
        `;
    }).join('');
    
    alertsContainer.innerHTML = alertsHTML;
}

function getAlertIcon(severity) {
    const icons = {
        'danger': 'exclamation-triangle',
        'warning': 'exclamation-circle',
        'info': 'info-circle',
        'success': 'check-circle'
    };
    return icons[severity] || 'info-circle';
}

async function showKPIDetails(kpiType) {
    try {
        // Use Django URL instead of direct API call to ensure authentication
        const response = await fetch(`/api/kpi/${kpiType}/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': MovIAx.api.getCSRFToken()
            },
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        displayKPIModal(kpiType, data);
    } catch (error) {
        console.error(`Failed to load KPI details for ${kpiType}:`, error);
        MovIAx.utils.showToast(`Error al cargar detalles de ${kpiType}`, 'danger');
    }
}

function displayKPIModal(kpiType, data) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles: ${getKPITitle(kpiType)}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    ${generateKPIDetailsHTML(kpiType, data.data)}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="window.print()">Imprimir</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Clean up modal after hiding
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

function generateKPIDetailsHTML(kpiType, data) {
    switch (kpiType) {
        case 'workorders':
            return `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Estado de Órdenes</h6>
                        <ul class="list-group">
                            ${(data.by_status || []).map(item => `
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>${item.status || 'Sin estado'}</span>
                                    <span class="badge bg-primary">${item.count}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Métricas</h6>
                        <p><strong>Total Activas:</strong> ${data.total_active || 0}</p>
                        <p><strong>Vencidas:</strong> ${data.overdue || 0}</p>
                        <p><strong>Esta Semana:</strong> ${data.this_week || 0}</p>
                    </div>
                </div>
            `;
        case 'invoices':
            return `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Análisis de Antigüedad</h6>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>0-30 días</span>
                                <span class="badge bg-success">${data.aging_analysis?.['0-30'] || 0}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>31-60 días</span>
                                <span class="badge bg-warning">${data.aging_analysis?.['31-60'] || 0}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>60+ días</span>
                                <span class="badge bg-danger">${data.aging_analysis?.['60+'] || 0}</span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Métricas Financieras</h6>
                        <p><strong>Total Pendientes:</strong> ${data.total_pending || 0}</p>
                        <p><strong>Vencidas:</strong> ${data.overdue || 0}</p>
                        <p><strong>Monto Pendiente:</strong> $${formatNumber(data.total_amount_pending || 0)}</p>
                    </div>
                </div>
            `;
        case 'inventory':
            return `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Estado del Inventario</h6>
                        <p><strong>Total Productos:</strong> ${data.total_products || 0}</p>
                        <p><strong>Stock Bajo:</strong> ${data.low_stock || 0}</p>
                        <p><strong>Stock Crítico:</strong> ${data.critical_stock || 0}</p>
                        <p><strong>Sin Stock:</strong> ${data.out_of_stock || 0}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Valor del Inventario</h6>
                        <p><strong>Valor Total:</strong> $${formatNumber(data.total_value || 0)}</p>
                        <h6>Por Almacén</h6>
                        <ul class="list-group">
                            ${(data.by_warehouse || []).map(wh => `
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>${wh.warehouse__name || 'Sin nombre'}</span>
                                    <span class="badge bg-info">${wh.total_items || 0}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;
        case 'productivity':
            return `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Productividad Semanal</h6>
                        <p><strong>Completadas:</strong> ${data.completed_this_week || 0}</p>
                        <p><strong>Total:</strong> ${data.total_this_week || 0}</p>
                        <p><strong>Tasa de Completado:</strong> ${data.completion_rate || 0}%</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Métricas de Eficiencia</h6>
                        <p><strong>Tiempo Promedio:</strong> ${data.avg_completion_time || 0} días</p>
                        <p><em>Más métricas disponibles próximamente</em></p>
                    </div>
                </div>
            `;
        default:
            return '<p>Detalles no disponibles para este KPI.</p>';
    }
}

function getKPITitle(kpiType) {
    const titles = {
        'workorders': 'Órdenes de Trabajo',
        'invoices': 'Facturas',
        'inventory': 'Inventario',
        'productivity': 'Productividad'
    };
    return titles[kpiType] || kpiType;
}

function formatNumber(num) {
    return new Intl.NumberFormat('es-MX').format(num);
}

function updateChartPeriod(period) {
    console.log('Updating chart period to:', period);
    // Implementation would fetch data for the selected period
    MovIAx.utils.showToast(`Período actualizado a ${period}`, 'info');
}

function toggleAutoRefresh() {
    const textElement = document.getElementById('auto-refresh-text');
    
    if (isAutoRefreshEnabled) {
        clearInterval(autoRefreshInterval);
        isAutoRefreshEnabled = false;
        textElement.textContent = 'Activar Auto-actualización';
        MovIAx.utils.showToast('Auto-actualización desactivada', 'info');
    } else {
        autoRefreshInterval = setInterval(refreshDashboard, 60000); // Every minute
        isAutoRefreshEnabled = true;
        textElement.textContent = 'Desactivar Auto-actualización';
        MovIAx.utils.showToast('Auto-actualización activada (cada minuto)', 'success');
    }
}

function refreshAlerts() {
    // Implementation would refresh alerts from API
    MovIAx.utils.showToast('Alertas actualizadas', 'info');
}

function exportDashboard() {
    // Implementation would export dashboard data
    MovIAx.utils.showToast('Exportando datos del dashboard...', 'info');
}

function printDashboard() {
    window.print();
}

// Auto-refresh dashboard every 5 minutes (optional)
setInterval(function() {
    if (!isAutoRefreshEnabled) {
        fetch('/api/dashboard-data/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': MovIAx.api.getCSRFToken()
            },
            credentials: 'include'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                updateKPIs(data);
            })
            .catch(error => {
                console.log('Background refresh failed:', error);
            });
    }
}, 300000); // 5 minutes
</script>
{% endblock %}