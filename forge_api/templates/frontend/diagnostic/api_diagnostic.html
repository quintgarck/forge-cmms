{% extends 'frontend/base/base.html' %}
{% load static %}

{% block title %}Diagnóstico API - MovIAx{% endblock %}
{% block body_class %}diagnostic-page{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item active">Diagnóstico API</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">
                    <i class="bi bi-activity me-2"></i>
                    Diagnóstico de API
                </h1>
                <p class="text-muted mb-0">Herramientas de diagnóstico y monitoreo del sistema</p>
            </div>
            <div>
                <button class="btn btn-primary" onclick="runFullDiagnostic()">
                    <i class="bi bi-play-circle me-1"></i>
                    Ejecutar Diagnóstico Completo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- System Status Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center" id="overall-status-card">
            <div class="card-body">
                <div class="status-indicator mb-2" id="overall-status-indicator">
                    <i class="bi bi-question-circle display-4 text-muted"></i>
                </div>
                <h5 class="card-title">Estado General</h5>
                <p class="card-text" id="overall-status-text">Ejecutando diagnóstico...</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="mb-2">
                    <i class="bi bi-clock display-4 text-info"></i>
                </div>
                <h5 class="card-title">Tiempo de Respuesta</h5>
                <p class="card-text" id="response-time-text">-- ms</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="mb-2">
                    <i class="bi bi-check-circle display-4 text-success"></i>
                </div>
                <h5 class="card-title">Pruebas Exitosas</h5>
                <p class="card-text" id="success-count-text">0 / 0</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="mb-2">
                    <i class="bi bi-exclamation-triangle display-4 text-warning"></i>
                </div>
                <h5 class="card-title">Errores</h5>
                <p class="card-text" id="error-count-text">0</p>
            </div>
        </div>
    </div>
</div><
!-- Diagnostic Tests -->
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-check me-2"></i>
                    Pruebas de Diagnóstico
                </h5>
            </div>
            <div class="card-body">
                <div id="diagnostic-tests">
                    <!-- Tests will be populated by JavaScript -->
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Ejecutando pruebas...</span>
                        </div>
                        <p class="mt-2 text-muted">Ejecutando pruebas de diagnóstico...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Real-time Monitoring -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-activity me-2"></i>
                    Monitoreo en Tiempo Real
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleMonitoring()" id="monitoring-toggle">
                        <i class="bi bi-play me-1"></i>
                        Iniciar Monitoreo
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="monitor-endpoint" class="form-label">Endpoint a Monitorear:</label>
                        <select class="form-select" id="monitor-endpoint">
                            <option value="health/">Health Check</option>
                            <option value="clients/">Clientes API</option>
                            <option value="products/">Productos API</option>
                            <option value="workorders/">Órdenes API</option>
                            <option value="dashboard/summary/">Dashboard API</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="monitor-interval" class="form-label">Intervalo (segundos):</label>
                        <select class="form-select" id="monitor-interval">
                            <option value="5">5 segundos</option>
                            <option value="10" selected>10 segundos</option>
                            <option value="30">30 segundos</option>
                            <option value="60">1 minuto</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-3">
                    <canvas id="monitoring-chart" width="400" height="200"></canvas>
                </div>
                
                <div class="mt-3" id="monitoring-log">
                    <!-- Monitoring results will appear here -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- System Information -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Información del Sistema
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td><strong>API Base URL:</strong></td>
                        <td><code>{{ api_base_url }}</code></td>
                    </tr>
                    <tr>
                        <td><strong>Usuario:</strong></td>
                        <td>{{ user_info.username|default:"No autenticado" }}</td>
                    </tr>
                    <tr>
                        <td><strong>Email:</strong></td>
                        <td>{{ user_info.email|default:"--" }}</td>
                    </tr>
                    <tr>
                        <td><strong>Staff:</strong></td>
                        <td>
                            {% if user_info.is_staff %}
                                <span class="badge bg-success">Sí</span>
                            {% else %}
                                <span class="badge bg-secondary">No</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Hora Actual:</strong></td>
                        <td>{{ current_time|date:"d/m/Y H:i:s" }}</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- Performance Metrics -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Métricas de Performance
                </h5>
            </div>
            <div class="card-body">
                <div id="performance-metrics">
                    <div class="text-center py-3">
                        <small class="text-muted">Ejecute el diagnóstico para ver métricas</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Error Log -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Log de Errores
                </h5>
            </div>
            <div class="card-body">
                <div id="error-log" style="max-height: 300px; overflow-y: auto;">
                    <div class="text-center py-3">
                        <small class="text-muted">No hay errores registrados</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.diagnostic-page .status-indicator {
    transition: all 0.3s ease;
}

.test-item {
    border-left: 4px solid #dee2e6;
    padding: 15px;
    margin-bottom: 10px;
    background: #f8f9fa;
    border-radius: 0 4px 4px 0;
}

.test-item.success {
    border-left-color: #198754;
    background: #d1e7dd;
}

.test-item.warning {
    border-left-color: #ffc107;
    background: #fff3cd;
}

.test-item.error {
    border-left-color: #dc3545;
    background: #f8d7da;
}

.monitoring-entry {
    padding: 8px 12px;
    margin-bottom: 5px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9em;
}

.monitoring-entry.success {
    background: #d1e7dd;
    color: #0f5132;
}

.monitoring-entry.warning {
    background: #fff3cd;
    color: #664d03;
}

.monitoring-entry.error {
    background: #f8d7da;
    color: #721c24;
}

.performance-metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #dee2e6;
}

.performance-metric:last-child {
    border-bottom: none;
}

.metric-value {
    font-weight: bold;
    font-family: monospace;
}

.metric-value.good {
    color: #198754;
}

.metric-value.warning {
    color: #ffc107;
}

.metric-value.bad {
    color: #dc3545;
}
</style>
{% endblock %}{% bl
ock extra_js %}
<script src="{% static 'frontend/vendor/chart.min.js' %}"></script>
<script>
// Diagnostic JavaScript
let monitoringInterval = null;
let monitoringChart = null;
let monitoringData = [];

document.addEventListener('DOMContentLoaded', function() {
    // Initialize monitoring chart
    initializeMonitoringChart();
    
    // Run initial diagnostic
    runFullDiagnostic();
});

async function runFullDiagnostic() {
    updateOverallStatus('running', 'Ejecutando diagnóstico...');
    
    try {
        const response = await fetch('/api/health-check/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                'Content-Type': 'application/json'
            }
        });
        
        const results = await response.json();
        displayDiagnosticResults(results);
        
    } catch (error) {
        console.error('Diagnostic failed:', error);
        updateOverallStatus('error', 'Error ejecutando diagnóstico');
        addErrorLog('Diagnostic Error', error.message);
    }
}

function displayDiagnosticResults(results) {
    // Update overall status
    updateOverallStatus(results.overall_status, getStatusMessage(results.overall_status));
    
    // Update summary cards
    document.getElementById('response-time-text').textContent = results.execution_time + ' ms';
    
    // Count successful and failed tests
    const testCounts = countTestResults(results.tests);
    document.getElementById('success-count-text').textContent = `${testCounts.success} / ${testCounts.total}`;
    document.getElementById('error-count-text').textContent = testCounts.errors;
    
    // Display individual test results
    displayTestResults(results.tests);
    
    // Display performance metrics
    displayPerformanceMetrics(results.performance);
    
    // Log any errors
    if (results.errors && results.errors.length > 0) {
        results.errors.forEach(error => {
            addErrorLog('System Error', error);
        });
    }
}

function updateOverallStatus(status, message) {
    const card = document.getElementById('overall-status-card');
    const indicator = document.getElementById('overall-status-indicator');
    const text = document.getElementById('overall-status-text');
    
    // Remove existing status classes
    card.classList.remove('border-success', 'border-warning', 'border-danger', 'border-info');
    
    let iconClass = 'bi-question-circle';
    let colorClass = 'text-muted';
    let borderClass = '';
    
    switch (status) {
        case 'success':
            iconClass = 'bi-check-circle';
            colorClass = 'text-success';
            borderClass = 'border-success';
            break;
        case 'warning':
            iconClass = 'bi-exclamation-triangle';
            colorClass = 'text-warning';
            borderClass = 'border-warning';
            break;
        case 'error':
            iconClass = 'bi-x-circle';
            colorClass = 'text-danger';
            borderClass = 'border-danger';
            break;
        case 'running':
            iconClass = 'bi-arrow-clockwise';
            colorClass = 'text-info';
            borderClass = 'border-info';
            break;
    }
    
    indicator.innerHTML = `<i class="bi ${iconClass} display-4 ${colorClass}"></i>`;
    text.textContent = message;
    if (borderClass) {
        card.classList.add(borderClass);
    }
}

function getStatusMessage(status) {
    const messages = {
        'success': 'Todos los sistemas funcionando correctamente',
        'warning': 'Algunos sistemas tienen advertencias',
        'error': 'Se detectaron errores críticos',
        'unknown': 'Estado desconocido'
    };
    return messages[status] || messages.unknown;
}

function countTestResults(tests) {
    let total = 0;
    let success = 0;
    let errors = 0;
    
    function countInObject(obj) {
        for (const key in obj) {
            const test = obj[key];
            if (test && typeof test === 'object') {
                if (test.status) {
                    total++;
                    if (test.status === 'success') success++;
                    if (test.status === 'error') errors++;
                } else {
                    // Nested tests
                    countInObject(test);
                }
            }
        }
    }
    
    countInObject(tests);
    return { total, success, errors };
}

function displayTestResults(tests) {
    const container = document.getElementById('diagnostic-tests');
    let html = '';
    
    // Connectivity test
    if (tests.connectivity) {
        html += createTestItem('Conectividad API', tests.connectivity);
    }
    
    // Authentication test
    if (tests.authentication) {
        html += createTestItem('Autenticación', tests.authentication);
    }
    
    // Database test
    if (tests.database) {
        html += createTestItem('Base de Datos', tests.database);
    }
    
    // Endpoint tests
    if (tests.endpoints) {
        html += '<h6 class="mt-3 mb-2">Endpoints de API:</h6>';
        for (const [endpoint, result] of Object.entries(tests.endpoints)) {
            const name = endpoint.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += createTestItem(name, result);
        }
    }
    
    container.innerHTML = html;
}

function createTestItem(name, result) {
    const statusClass = result.status || 'unknown';
    const icon = getStatusIcon(result.status);
    const responseTime = result.response_time ? ` (${result.response_time}ms)` : '';
    
    return `
        <div class="test-item ${statusClass}">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1">
                        <i class="bi ${icon} me-2"></i>
                        ${name}
                    </h6>
                    <p class="mb-1">${result.message || 'Sin mensaje'}${responseTime}</p>
                    ${result.details ? `<small class="text-muted">Detalles: ${JSON.stringify(result.details)}</small>` : ''}
                </div>
                <span class="badge bg-${getStatusBadgeColor(result.status)}">${result.status || 'unknown'}</span>
            </div>
        </div>
    `;
}

function getStatusIcon(status) {
    const icons = {
        'success': 'bi-check-circle',
        'warning': 'bi-exclamation-triangle',
        'error': 'bi-x-circle',
        'unknown': 'bi-question-circle'
    };
    return icons[status] || icons.unknown;
}

function getStatusBadgeColor(status) {
    const colors = {
        'success': 'success',
        'warning': 'warning',
        'error': 'danger',
        'unknown': 'secondary'
    };
    return colors[status] || colors.unknown;
}

function displayPerformanceMetrics(performance) {
    const container = document.getElementById('performance-metrics');
    
    if (!performance || Object.keys(performance).length === 0) {
        container.innerHTML = '<div class="text-center py-3"><small class="text-muted">No hay métricas disponibles</small></div>';
        return;
    }
    
    let html = '';
    
    if (performance.average_response_time !== null) {
        html += createMetricItem('Tiempo Promedio', performance.average_response_time + ' ms', getPerformanceClass(performance.average_response_time, 500, 1000));
    }
    
    if (performance.fastest_response !== null) {
        html += createMetricItem('Respuesta Más Rápida', performance.fastest_response + ' ms', 'good');
    }
    
    if (performance.slowest_response !== null) {
        html += createMetricItem('Respuesta Más Lenta', performance.slowest_response + ' ms', getPerformanceClass(performance.slowest_response, 1000, 2000));
    }
    
    if (performance.total_requests) {
        html += createMetricItem('Total Requests', performance.total_requests, 'neutral');
    }
    
    if (performance.successful_requests !== undefined) {
        const successRate = performance.total_requests > 0 ? 
            ((performance.successful_requests / performance.total_requests) * 100).toFixed(1) + '%' : '0%';
        html += createMetricItem('Tasa de Éxito', successRate, getPerformanceClass(parseFloat(successRate), 95, 80));
    }
    
    container.innerHTML = html;
}

function createMetricItem(label, value, className) {
    return `
        <div class="performance-metric">
            <span>${label}:</span>
            <span class="metric-value ${className}">${value}</span>
        </div>
    `;
}

function getPerformanceClass(value, goodThreshold, warningThreshold) {
    if (value <= goodThreshold) return 'good';
    if (value <= warningThreshold) return 'warning';
    return 'bad';
}

function addErrorLog(type, message) {
    const container = document.getElementById('error-log');
    const timestamp = new Date().toLocaleTimeString();
    
    const errorHtml = `
        <div class="alert alert-danger alert-sm mb-2">
            <strong>[${timestamp}] ${type}:</strong> ${message}
        </div>
    `;
    
    if (container.innerHTML.includes('No hay errores registrados')) {
        container.innerHTML = errorHtml;
    } else {
        container.insertAdjacentHTML('afterbegin', errorHtml);
    }
    
    // Limit to 10 error messages
    const errors = container.querySelectorAll('.alert');
    if (errors.length > 10) {
        errors[errors.length - 1].remove();
    }
}

// Monitoring functions
function toggleMonitoring() {
    const button = document.getElementById('monitoring-toggle');
    
    if (monitoringInterval) {
        // Stop monitoring
        clearInterval(monitoringInterval);
        monitoringInterval = null;
        button.innerHTML = '<i class="bi bi-play me-1"></i>Iniciar Monitoreo';
        button.classList.remove('btn-outline-danger');
        button.classList.add('btn-outline-primary');
    } else {
        // Start monitoring
        const endpoint = document.getElementById('monitor-endpoint').value;
        const interval = parseInt(document.getElementById('monitor-interval').value) * 1000;
        
        monitoringInterval = setInterval(() => {
            monitorEndpoint(endpoint);
        }, interval);
        
        button.innerHTML = '<i class="bi bi-stop me-1"></i>Detener Monitoreo';
        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-outline-danger');
        
        // Run first check immediately
        monitorEndpoint(endpoint);
    }
}

async function monitorEndpoint(endpoint) {
    try {
        const response = await fetch('/api/connection-monitor/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ endpoint: endpoint })
        });
        
        const result = await response.json();
        addMonitoringEntry(result);
        updateMonitoringChart(result);
        
    } catch (error) {
        console.error('Monitoring request failed:', error);
        const errorResult = {
            status: 'error',
            message: 'Monitoring request failed',
            timestamp: new Date().toISOString(),
            endpoint: endpoint
        };
        addMonitoringEntry(errorResult);
    }
}

function addMonitoringEntry(result) {
    const container = document.getElementById('monitoring-log');
    const timestamp = new Date(result.timestamp).toLocaleTimeString();
    
    const entryHtml = `
        <div class="monitoring-entry ${result.status}">
            [${timestamp}] ${result.endpoint}: ${result.message}
            ${result.response_time ? ` (${result.response_time}ms)` : ''}
        </div>
    `;
    
    container.insertAdjacentHTML('afterbegin', entryHtml);
    
    // Limit to 20 entries
    const entries = container.querySelectorAll('.monitoring-entry');
    if (entries.length > 20) {
        entries[entries.length - 1].remove();
    }
}

function initializeMonitoringChart() {
    const ctx = document.getElementById('monitoring-chart').getContext('2d');
    
    monitoringChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Tiempo de Respuesta (ms)',
                data: [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Tiempo (ms)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Tiempo'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateMonitoringChart(result) {
    if (!monitoringChart || !result.response_time) return;
    
    const timestamp = new Date(result.timestamp).toLocaleTimeString();
    
    // Add new data point
    monitoringChart.data.labels.push(timestamp);
    monitoringChart.data.datasets[0].data.push(result.response_time);
    
    // Keep only last 20 data points
    if (monitoringChart.data.labels.length > 20) {
        monitoringChart.data.labels.shift();
        monitoringChart.data.datasets[0].data.shift();
    }
    
    monitoringChart.update('none');
}
</script>
{% endblock %}