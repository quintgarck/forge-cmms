{% extends "frontend/base/base.html" %}

{% block title %}Detalle de Factura - MovIAx{% endblock %}

{% block body_class %}invoice-page{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="{% url 'frontend:dashboard' %}">MovIAx</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'frontend:invoice_list' %}">Facturas</a></li>
                        <li class="breadcrumb-item active">Detalle</li>
                    </ol>
                </div>
                <h4 class="page-title">Detalle de Factura</h4>
            </div>
        </div>
    </div>

    {% if invoice %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="header-title">Información de la Factura</h4>
                            <div class="table-responsive">
                                <table class="table table-borderless mb-0">
                                    <tbody>
                                        <tr>
                                            <td class="ps-0">Número:</td>
                                            <td class="text-end"><strong>{{ invoice.invoice_number }}</strong></td>
                                        </tr>
                                        <tr>
                                            <td class="ps-0">Fecha:</td>
                                            <td class="text-end">{{ invoice.invoice_date }}</td>
                                        </tr>
                                        <tr>
                                            <td class="ps-0">Vencimiento:</td>
                                            <td class="text-end">{{ invoice.due_date }}</td>
                                        </tr>
                                        <tr>
                                            <td class="ps-0">Estado:</td>
                                            <td class="text-end">
                                                <span class="badge 
                                                    {% if invoice.status == 'paid' %}bg-success
                                                    {% elif invoice.status == 'sent' %}bg-info
                                                    {% elif invoice.status == 'overdue' %}bg-danger
                                                    {% elif invoice.status == 'cancelled' %}bg-secondary
                                                    {% elif invoice.status == 'draft' %}bg-warning
                                                    {% else %}bg-light{% endif %}">
                                                    {{ invoice.get_status_display|default:invoice.status }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% if invoice.is_overdue %}
                                        <tr>
                                            <td class="ps-0">Vencimiento:</td>
                                            <td class="text-end">
                                                <span class="badge bg-danger">{{ invoice.overdue_label }}</span>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4 class="header-title">Cliente</h4>
                            <div class="table-responsive">
                                <table class="table table-borderless mb-0">
                                    <tbody>
                                        <tr>
                                            <td class="ps-0">Nombre:</td>
                                            <td class="text-end">{{ invoice.client.name }}</td>
                                        </tr>
                                        <tr>
                                            <td class="ps-0">Email:</td>
                                            <td class="text-end">{{ invoice.client.email|default:'-' }}</td>
                                        </tr>
                                        <tr>
                                            <td class="ps-0">Teléfono:</td>
                                            <td class="text-end">{{ invoice.client.phone|default:'-' }}</td>
                                        </tr>
                                        <tr>
                                            <td class="ps-0">Dirección:</td>
                                            <td class="text-end">{{ invoice.client.address|default:'-' }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <h4 class="header-title">Resumen de la Factura</h4>
                    <div class="table-responsive">
                        <table class="table table-centered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Concepto</th>
                                    <th class="text-end">Monto</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Subtotal</td>
                                    <td class="text-end">${{ invoice.subtotal|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td>Impuestos</td>
                                    <td class="text-end">${{ invoice.tax_amount|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td>Descuento</td>
                                    <td class="text-end">-${{ invoice.discount_amount|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td class="text-dark"><b>Total</b></td>
                                    <td class="text-dark text-end"><b>${{ invoice.total_amount|floatformat:2 }}</b></td>
                                </tr>
                                <tr>
                                    <td>Pagado</td>
                                    <td class="text-end">${{ invoice.paid_amount|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td class="text-dark"><b>Saldo Pendiente</b></td>
                                    <td class="text-dark text-end"><b>${{ invoice.balance_due|floatformat:2 }}</b></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-body">
                    <h4 class="header-title">Estado de Pago</h4>
                    <div class="text-center">
                        <div class="mt-3">
                            <span class="badge 
                                {% if invoice.payment_status == 'paid' %}bg-success
                                {% elif invoice.payment_status == 'partial' %}bg-warning
                                {% else %}bg-danger{% endif %} 
                                fs-4">
                                {{ invoice.payment_status_label }}
                            </span>
                        </div>
                        <div class="mt-3">
                            <p class="mb-1">Total: ${{ invoice.total_amount|floatformat:2 }}</p>
                            <p class="mb-1">Pagado: ${{ invoice.paid_amount|floatformat:2 }}</p>
                            <p class="mb-0">Pendiente: ${{ invoice.balance_due|floatformat:2 }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h4 class="header-title">Acciones</h4>
                    <div class="d-grid gap-2">
                        <a href="{% url 'frontend:invoice_update' invoice.id %}" class="btn btn-primary">
                            <i class="fas fa-edit"></i> Editar Factura
                        </a>
                        <a href="{% url 'frontend:invoice_delete' invoice.id %}" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Eliminar Factura
                        </a>
                        <button class="btn btn-success">
                            <i class="fas fa-file-pdf"></i> Generar PDF
                        </button>
                        <button class="btn btn-info">
                            <i class="fas fa-envelope"></i> Enviar por Email
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if invoice.notes %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4 class="header-title">Notas</h4>
                    <p class="text-muted">{{ invoice.notes }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-exclamation-triangle text-warning h1"></i>
                    <h4 class="mt-3">Factura no encontrada</h4>
                    <p class="text-muted">La factura que está buscando no existe o ha sido eliminada.</p>
                    <a href="{% url 'frontend:invoice_list' %}" class="btn btn-primary">
                        <i class="fas fa-arrow-left"></i> Volver a la lista de facturas
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}