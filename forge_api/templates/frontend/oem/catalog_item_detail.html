{% extends 'frontend/base/base.html' %}
{% load static %}

{% block title %}{{ catalog_item.part_number }} - Catálogo OEM - MovIAx{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item">
        <a href="{% url 'frontend:oem_brand_management' %}">Catálogo OEM</a>
    </li>
    <li class="breadcrumb-item">
        <a href="{% url 'frontend:oem_catalog_item_list' %}">Catálogo</a>
    </li>
    <li class="breadcrumb-item active">{{ catalog_item.part_number }}</li>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
    <div class="col">
        <div class="d-flex align-items-center">
            {% if catalog_item.image_url %}
                <img src="{{ catalog_item.image_url }}" alt="{{ catalog_item.part_number }}" class="me-3" style="height: 80px; width: auto; object-fit: contain;">
            {% else %}
                <i class="bi bi-grid display-4 me-3 text-primary"></i>
            {% endif %}
            <div>
                <h1 class="h3 mb-1">{{ catalog_item.part_number }}</h1>
                <p class="text-muted mb-0">
                    <a href="{% url 'frontend:oem_brand_list' %}?search={{ catalog_item.oem_code }}" class="text-decoration-none">
                        <strong>{{ catalog_item.oem_code }}</strong>
                    </a>
                    {% if catalog_item.description_es %}
                        | {{ catalog_item.description_es|truncatewords:10 }}
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    <div class="col-auto">
        <a href="{% url 'frontend:oem_catalog_item_update' catalog_item.catalog_id %}" class="btn btn-warning me-2">
            <i class="bi bi-pencil me-1"></i>
            Editar
        </a>
        <a href="{% url 'frontend:oem_catalog_item_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>
            Volver
        </a>
    </div>
</div>

<div class="row">
    <!-- Main Information Column -->
    <div class="col-lg-6">
        <!-- Basic Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Información Básica
                </h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5 text-muted">Código OEM:</dt>
                    <dd class="col-sm-7">
                        <a href="{% url 'frontend:oem_brand_list' %}?search={{ catalog_item.oem_code }}" class="text-decoration-none">
                            <strong class="text-primary">{{ catalog_item.oem_code }}</strong>
                        </a>
                    </dd>

                    <dt class="col-sm-5 text-muted">Número de Parte:</dt>
                    <dd class="col-sm-7">
                        <strong>{{ catalog_item.part_number }}</strong>
                    </dd>

                    <dt class="col-sm-5 text-muted">Tipo:</dt>
                    <dd class="col-sm-7">
                        {% if catalog_item.item_type == 'VEHICLE_MODEL' %}
                            <span class="badge bg-info">
                                <i class="bi bi-car-front me-1"></i>
                                Modelo de Vehículo
                            </span>
                        {% elif item.item_type == 'EQUIPMENT_MODEL' %}
                            <span class="badge bg-warning">
                                <i class="bi bi-tools me-1"></i>
                                Modelo de Maquinaria
                            </span>
                        {% elif item.item_type == 'PART' %}
                            <span class="badge bg-secondary">
                                <i class="bi bi-box me-1"></i>
                                Parte/Repuesto
                            </span>
                        {% else %}
                            <span class="badge bg-dark">{{ catalog_item.item_type }}</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-5 text-muted">Descripción:</dt>
                    <dd class="col-sm-7">{{ catalog_item.description_es|default:"Sin descripción" }}</dd>

                    <dt class="col-sm-5 text-muted">Estado:</dt>
                    <dd class="col-sm-7">
                        {% if catalog_item.is_active %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle me-1"></i>
                                Activo
                            </span>
                        {% else %}
                            <span class="badge bg-secondary">
                                <i class="bi bi-pause-circle me-1"></i>
                                Inactivo
                            </span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-5 text-muted">Orden de Vista:</dt>
                    <dd class="col-sm-7">{{ catalog_item.display_order|default:"Sin especificar" }}</dd>
                </dl>
            </div>
        </div>

        <!-- Years and Specifications -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-range me-2"></i>
                    Años y Especificaciones
                </h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5 text-muted">Año Inicio:</dt>
                    <dd class="col-sm-7">
                        {% if catalog_item.year_start %}
                            <span class="badge bg-light text-dark">{{ catalog_item.year_start }}</span>
                        {% else %}
                            <span class="text-muted">No especificado</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-5 text-muted">Año Fin:</dt>
                    <dd class="col-sm-7">
                        {% if catalog_item.year_end %}
                            <span class="badge bg-light text-dark">{{ catalog_item.year_end }}</span>
                        {% else %}
                            <span class="text-muted">No especificado</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-5 text-muted">Rango de Años:</dt>
                    <dd class="col-sm-7">
                        {% if catalog_item.year_start and item.year_end %}
                            <strong>{{ catalog_item.year_start }} - {{ catalog_item.year_end }}</strong>
                            <small class="text-muted">({{ catalog_item.year_end|add:'-'|add:item.year_start|add:'1' }} años)</small>
                        {% elif item.year_start %}
                            <strong>{{ catalog_item.year_start }}+</strong>
                        {% else %}
                            <span class="text-muted">No especificado</span>
                        {% endif %}
                    </dd>

                    {% if catalog_item.body_style %}
                        <dt class="col-sm-5 text-muted">Atributos:</dt>
                        <dd class="col-sm-7">
                            <small class="text-muted">{{ catalog_item.body_style }}</small>
                        </dd>
                    {% endif %}
                </dl>
            </div>
        </div>

        <!-- Metadata -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    Metadatos
                </h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5 text-muted">ID Catálogo:</dt>
                    <dd class="col-sm-7"><code>{{ catalog_item.catalog_id }}</code></dd>

                    <dt class="col-sm-5 text-muted">Creado:</dt>
                    <dd class="col-sm-7">
                        {% if catalog_item.created_at %}
                            <small class="text-muted">
                                {{ catalog_item.created_at|date:"d/m/Y H:i" }}
                            </small>
                        {% else %}
                            <span class="text-muted">No disponible</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-5 text-muted">Actualizado:</dt>
                    <dd class="col-sm-7">
                        {% if catalog_item.updated_at %}
                            <small class="text-muted">
                                {{ catalog_item.updated_at|date:"d/m/Y H:i" }}
                            </small>
                        {% else %}
                            <span class="text-muted">No disponible</span>
                        {% endif %}
                    </dd>
                </dl>
            </div>
        </div>
    </div>

    <!-- Pricing and Replacement Column -->
    <div class="col-lg-6">
        <!-- Pricing Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-currency-dollar me-2"></i>
                    Información de Precios
                </h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5 text-muted">MSRP (Precio Sugerido):</dt>
                    <dd class="col-sm-7">
                        {% if catalog_item.list_price %}
                            <strong class="text-success fs-5">
                                ${{ catalog_item.list_price }}
                            </strong>
                        {% else %}
                            <span class="text-muted">No especificado</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-5 text-muted">Precio Distribuidor:</dt>
                    <dd class="col-sm-7">
                        {% if catalog_item.net_price %}
                            <strong class="text-primary">
                                ${{ catalog_item.net_price }}
                            </strong>
                        {% else %}
                            <span class="text-muted">No especificado</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-5 text-muted">Costo:</dt>
                    <dd class="col-sm-7">
                        {% if catalog_item.list_price %}
                            <strong class="text-secondary">
                                ${{ catalog_item.list_price }}
                            </strong>
                        {% else %}
                            <span class="text-muted">No especificado</span>
                        {% endif %}
                    </dd>

                    {% if catalog_item.list_price and item.cost_price %}
                        <dt class="col-sm-5 text-muted">Margen Aproximado:</dt>
                        <dd class="col-sm-7">
                            {% widthratio item.msrp_price item.cost_price 1 as ratio %}
                            {% widthratio ratio 1 100 as margin %}
                            <span class="badge bg-info">
                                {{ margin|floatformat:0 }}% margen
                            </span>
                        </dd>
                    {% endif %}
                </dl>
            </div>
        </div>

        <!-- Replacement Information -->
        {% if catalog_item.superseded_by %}
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Información de Reemplazo
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-0">
                        <p class="mb-2">
                            <strong>Esta parte ha sido reemplazada</strong>
                        </p>
                        <p class="mb-0">
                            Nuevo número de parte: 
                            <strong>{{ catalog_item.superseded_by }}</strong>
                        </p>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Image -->
        {% if catalog_item.image_url %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-image me-2"></i>
                        Imagen del Producto
                    </h5>
                </div>
                <div class="card-body text-center">
                    <img src="{{ catalog_item.image_url }}" alt="{{ catalog_item.part_number }}" class="img-fluid rounded" style="max-height: 300px;">
                    <div class="mt-2">
                        <a href="{{ catalog_item.image_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right me-1"></i>
                            Ver en tamaño completo
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Danger Zone -->
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Zona de Peligro
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Al eliminar este item del catálogo se eliminarán todas las referencias y relaciones asociadas.
                </p>
                <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    <i class="bi bi-trash me-1"></i>
                    Eliminar Item del Catálogo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar el item <strong>{{ catalog_item.part_number }}</strong>?</p>
                <p class="text-danger mb-0">
                    <i class="bi bi-info-circle me-1"></i>
                    Esta acción no se puede deshacer y eliminará:
                </p>
                <ul class="text-danger">
                    <li>El item {{ catalog_item.part_number }}</li>
                    <li>Todas las equivalencias asociadas</li>
                    <li>Todas las referencias en equipos</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form action="{% url 'frontend:oem_catalog_item_delete' catalog_item.catalog_id %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>
                        Eliminar Permanentemente
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}



