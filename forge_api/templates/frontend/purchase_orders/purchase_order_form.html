{% extends 'frontend/base/base.html' %}
{% load static %}

{% block title %}{{ form_title }} - MovIAx{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'frontend:purchase_order_list' %}">Órdenes de Compra</a></li>
    {% if form_action == 'update' and purchase_order %}
        <li class="breadcrumb-item active">Editar</li>
    {% else %}
        <li class="breadcrumb-item active">Nuevo</li>
    {% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .po-form-card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    [data-theme="dark"] .po-form-card {
        background-color: var(--moviax-bg-primary);
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3);
    }
    
    .po-items-card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    [data-theme="dark"] .po-items-card {
        background-color: var(--moviax-bg-primary);
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3);
    }
    
    .form-section {
        border-left: 3px solid var(--moviax-primary);
        padding-left: 1rem;
        margin-bottom: 1.5rem;
    }
    
    [data-theme="dark"] .form-section {
        border-left-color: var(--moviax-primary);
    }
    
    .item-row {
        border-bottom: 1px solid var(--moviax-border);
        padding-bottom: 0.75rem;
        margin-bottom: 0.75rem;
    }
    
    .item-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    [data-theme="dark"] .item-row {
        border-bottom-color: var(--moviax-border);
    }
    
    .summary-card {
        background: var(--moviax-bg-tertiary);
        border-radius: 0.375rem;
        padding: 1rem;
    }
    
    [data-theme="dark"] .summary-card {
        background: var(--moviax-bg-tertiary);
    }
    
    .btn-add-item {
        background: var(--moviax-success);
        border-color: var(--moviax-success);
        color: white;
    }
    
    .btn-add-item:hover {
        background: var(--moviax-success);
        border-color: var(--moviax-success);
        color: white;
        opacity: 0.9;
    }
    
    [data-theme="dark"] .btn-add-item {
        background: var(--moviax-success);
        border-color: var(--moviax-success);
    }
    
    .form-control, .form-select {
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-xl-10 col-lg-12">
        <div class="po-form-card card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-cart me-2"></i>{{ form_title }}</h4>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <!-- Purchase Order Details Section -->
                    <div class="form-section">
                        <h5 class="mb-4"><i class="bi bi-info-circle text-primary me-2"></i>Detalles de la Orden</h5>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="po_number" class="form-label fw-semibold">Número de Orden <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="po_number" name="po_number" 
                                       value="{% if purchase_order %}{{ purchase_order.po_number }}{% endif %}" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="supplier" class="form-label fw-semibold">Proveedor <span class="text-danger">*</span></label>
                                <select class="form-select" id="supplier" name="supplier" required>
                                    <option value="">Seleccione un proveedor</option>
                                    {% for supplier in suppliers %}
                                        <option value="{{ supplier.supplier_id }}" 
                                                {% if purchase_order and purchase_order.supplier.supplier_id == supplier.supplier_id %}selected{% endif %}>
                                            {{ supplier.name }} ({{ supplier.supplier_code }})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="order_date" class="form-label fw-semibold">Fecha de Orden <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="order_date" name="order_date" 
                                       value="{% if purchase_order %}{{ purchase_order.order_date|date:'Y-m-d' }}{% endif %}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="expected_delivery_date" class="form-label fw-semibold">Fecha Esperada de Entrega</label>
                                <input type="date" class="form-control" id="expected_delivery_date" name="expected_delivery_date" 
                                       value="{% if purchase_order %}{{ purchase_order.expected_delivery_date|date:'Y-m-d'|default:'' }}{% endif %}">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="status" class="form-label fw-semibold">Estado <span class="text-danger">*</span></label>
                                <select class="form-select" id="status" name="status" required>
                                    <option value="DRAFT" {% if not purchase_order or purchase_order.status == 'DRAFT' %}selected{% endif %}>Borrador</option>
                                    <option value="SUBMITTED" {% if purchase_order.status == 'SUBMITTED' %}selected{% endif %}>Enviada</option>
                                    <option value="APPROVED" {% if purchase_order.status == 'APPROVED' %}selected{% endif %}>Aprobada</option>
                                    <option value="ORDERED" {% if purchase_order.status == 'ORDERED' %}selected{% endif %}>Ordenada</option>
                                    <option value="RECEIVED" {% if purchase_order.status == 'RECEIVED' %}selected{% endif %}>Recibida</option>
                                    <option value="PARTIAL" {% if purchase_order.status == 'PARTIAL' %}selected{% endif %}>Parcialmente Recibida</option>
                                    <option value="CANCELLED" {% if purchase_order.status == 'CANCELLED' %}selected{% endif %}>Cancelada</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="notes" class="form-label fw-semibold">Notas</label>
                                <textarea class="form-control" id="notes" name="notes" rows="3">{% if purchase_order %}{{ purchase_order.notes }}{% endif %}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Purchase Order Items Section -->
                    <div class="form-section">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5><i class="bi bi-list-task text-primary me-2"></i>Productos/Servicios</h5>
                            <button type="button" id="add-item-btn" class="btn btn-add-item">
                                <i class="bi bi-plus-lg me-1"></i> Agregar Producto/Servicio
                            </button>
                        </div>
                        
                        <div class="po-items-card card">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-borderless mb-0" id="po-items-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="ps-4">SKU Interno</th>
                                                <th>Descripción</th>
                                                <th>Cantidad</th>
                                                <th>Precio Unitario</th>
                                                <th>Descuento (%)</th>
                                                <th>Impuesto (%)</th>
                                                <th>Total</th>
                                                <th class="pe-4">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="po-items-list">
                                            {% if purchase_order and po_items %}
                                                {% for item in po_items %}
                                                <tr class="item-row po-item-row" data-item-id="{{ item.po_item_id }}">
                                                    <td class="ps-4">
                                                        <input type="hidden" name="item_id" value="{{ item.po_item_id }}">
                                                        <input type="text" class="form-control form-control-sm" name="item_internal_sku" value="{{ item.internal_sku }}" required>
                                                    </td>
                                                    <td><input type="text" class="form-control form-control-sm" name="item_description" value="{{ item.description }}" required></td>
                                                    <td><input type="number" class="form-control form-control-sm item-quantity" name="item_quantity" value="{{ item.quantity }}" min="1" required></td>
                                                    <td><input type="number" step="0.01" class="form-control form-control-sm item-unit-price" name="item_unit_price" value="{{ item.unit_price }}" min="0" required></td>
                                                    <td><input type="number" step="0.01" class="form-control form-control-sm item-discount" name="item_discount_percent" value="{{ item.discount_percent }}" min="0" max="100"></td>
                                                    <td><input type="number" step="0.01" class="form-control form-control-sm item-tax" name="item_tax_percent" value="{{ item.tax_percent }}" min="0" max="100"></td>
                                                    <td class="item-total"><strong>${{ item.total_price|floatformat:2 }}</strong></td>
                                                    <td class="pe-4"><button type="button" class="btn btn-sm btn-outline-danger remove-item-btn"><i class="bi bi-trash"></i></button></td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                            <tr class="item-row po-item-row">
                                                <td class="ps-4"><input type="text" class="form-control form-control-sm" name="item_internal_sku" placeholder="SKU del producto" required></td>
                                                <td><input type="text" class="form-control form-control-sm" name="item_description" placeholder="Descripción del producto" required></td>
                                                <td><input type="number" class="form-control form-control-sm item-quantity" name="item_quantity" value="1" min="1" required></td>
                                                <td><input type="number" step="0.01" class="form-control form-control-sm item-unit-price" name="item_unit_price" value="0.00" min="0" required></td>
                                                <td><input type="number" step="0.01" class="form-control form-control-sm item-discount" name="item_discount_percent" value="0.00" min="0" max="100"></td>
                                                <td><input type="number" step="0.01" class="form-control form-control-sm item-tax" name="item_tax_percent" value="0.00" min="0" max="100"></td>
                                                <td class="item-total"><strong>$0.00</strong></td>
                                                <td class="pe-4"><button type="button" class="btn btn-sm btn-outline-danger remove-item-btn"><i class="bi bi-trash"></i></button></td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Summary Section -->
                                <div class="summary-card mt-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">Total de Items:</h6>
                                            <small class="text-muted">Suma de todos los productos/servicios</small>
                                        </div>
                                        <h4 class="mb-0 text-primary"><strong>$<span id="items-total">{% if items_total %}{{ items_total|floatformat:2 }}{% else %}0.00{% endif %}</span></strong></h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                        <a href="{% if purchase_order %}{% url 'frontend:purchase_order_detail' purchase_order.po_id %}{% else %}{% url 'frontend:purchase_order_list' %}{% endif %}" 
                           class="btn btn-secondary px-4">
                            <i class="bi bi-arrow-left me-1"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary px-4">
                            {% if form_action == 'update' %}<i class="bi bi-save me-1"></i>Actualizar{% else %}<i class="bi bi-plus-lg me-1"></i>Crear{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addItemBtn = document.getElementById('add-item-btn');
        const poItemsList = document.getElementById('po-items-list');
        const itemsTotalEl = document.getElementById('items-total');
        
        // Function to calculate item total
        function calculateItemTotal(row) {
            const quantityInput = row.querySelector('.item-quantity');
            const unitPriceInput = row.querySelector('.item-unit-price');
            const discountInput = row.querySelector('.item-discount');
            const taxInput = row.querySelector('.item-tax');
            const totalEl = row.querySelector('.item-total');
            
            const quantity = parseFloat(quantityInput.value) || 0;
            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            const discountPercent = parseFloat(discountInput.value) || 0;
            const taxPercent = parseFloat(taxInput.value) || 0;
            
            let subtotal = quantity * unitPrice;
            let discountAmount = subtotal * (discountPercent / 100);
            let afterDiscount = subtotal - discountAmount;
            let taxAmount = afterDiscount * (taxPercent / 100);
            let total = afterDiscount + taxAmount;
            
            totalEl.innerHTML = '<strong>$' + total.toFixed(2) + '</strong>';
            calculateOverallTotal();
        }
        
        // Function to calculate overall total
        function calculateOverallTotal() {
            let overallTotal = 0;
            const itemTotals = document.querySelectorAll('.item-total');
            
            itemTotals.forEach(function(totalEl) {
                const text = totalEl.textContent;
                const amount = parseFloat(text.replace('$', '')) || 0;
                overallTotal += amount;
            });
            
            itemsTotalEl.textContent = overallTotal.toFixed(2);
        }
        
        // Add event listeners for calculation when inputs change
        function attachCalculationListeners(row) {
            const inputs = row.querySelectorAll('.item-quantity, .item-unit-price, .item-discount, .item-tax');
            inputs.forEach(function(input) {
                input.addEventListener('input', function() {
                    calculateItemTotal(row);
                });
                input.addEventListener('blur', function() {
                    calculateItemTotal(row);
                });
            });
        }
        
        // Add event listener for remove buttons
        function attachRemoveListeners(row) {
            const removeBtn = row.querySelector('.remove-item-btn');
            removeBtn.addEventListener('click', function() {
                row.remove();
                calculateOverallTotal();
            });
        }
        
        // Add new item row
        addItemBtn.addEventListener('click', function() {
            const newRow = document.createElement('tr');
            newRow.className = 'item-row po-item-row';
            newRow.innerHTML = `
                <td class="ps-4"><input type="text" class="form-control form-control-sm" name="item_internal_sku" placeholder="SKU del producto" required></td>
                <td><input type="text" class="form-control form-control-sm" name="item_description" placeholder="Descripción del producto" required></td>
                <td><input type="number" class="form-control form-control-sm item-quantity" name="item_quantity" value="1" min="1" required></td>
                <td><input type="number" step="0.01" class="form-control form-control-sm item-unit-price" name="item_unit_price" value="0.00" min="0" required></td>
                <td><input type="number" step="0.01" class="form-control form-control-sm item-discount" name="item_discount_percent" value="0.00" min="0" max="100"></td>
                <td><input type="number" step="0.01" class="form-control form-control-sm item-tax" name="item_tax_percent" value="0.00" min="0" max="100"></td>
                <td class="item-total"><strong>$0.00</strong></td>
                <td class="pe-4"><button type="button" class="btn btn-sm btn-outline-danger remove-item-btn"><i class="bi bi-trash"></i></button></td>
            `;
            
            poItemsList.appendChild(newRow);
            attachCalculationListeners(newRow);
            attachRemoveListeners(newRow);
            
            // Add initial calculation event
            calculateItemTotal(newRow);
        });
        
        // Attach listeners to existing rows
        document.querySelectorAll('.po-item-row').forEach(function(row) {
            attachCalculationListeners(row);
            attachRemoveListeners(row);
        });
        
        // Initial calculation
        calculateOverallTotal();
    });
</script>
{% endblock %}