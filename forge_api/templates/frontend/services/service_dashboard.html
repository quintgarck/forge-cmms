{% extends 'frontend/base/base.html' %}
{% load static %}

{% block title %}Dashboard de Servicios - MovIAx{% endblock %}

{% block body_class %}service-page{% endblock %}

{% block extra_css %}
<style>
    .kpi-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .kpi-value {
        font-size: 2rem;
        font-weight: 600;
    }
    #loading-kpis {
        display: none;
    }
    #loading-kpis.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h2><i class="bi bi-speedometer2 me-2"></i>Dashboard de Servicios</h2>
                <p class="text-muted mb-0">Control integral de operaciones de servicio y mantenimiento</p>
            </div>
            <div class="d-flex gap-2">
                <!-- Selector de Período -->
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="period" id="period-today" value="today" {% if period == 'today' %}checked{% endif %}>
                    <label class="btn btn-outline-primary" for="period-today">Hoy</label>
                    
                    <input type="radio" class="btn-check" name="period" id="period-week" value="week" {% if period == 'week' %}checked{% endif %}>
                    <label class="btn btn-outline-primary" for="period-week">Semana</label>
                    
                    <input type="radio" class="btn-check" name="period" id="period-month" value="month" {% if period == 'month' %}checked{% endif %}>
                    <label class="btn btn-outline-primary" for="period-month">Mes</label>
                    
                    <input type="radio" class="btn-check" name="period" id="period-custom" value="custom">
                    <label class="btn btn-outline-primary" for="period-custom">Personalizado</label>
                </div>
                
                <a href="{% url 'frontend:workorder_create' %}" class="btn btn-primary">
                    <i class="bi bi-plus-lg me-1"></i>Nueva Orden
                </a>
                
                <button type="button" class="btn btn-outline-secondary" id="refresh-dashboard" title="Actualizar datos">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>
        
        <!-- Selector de fechas personalizado (inicialmente oculto) -->
        <div class="mt-3" id="custom-date-range" style="display: none;">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="start_date" class="form-label">Fecha Inicio</label>
                    <input type="date" class="form-control" id="start_date" value="{{ date_from }}">
                </div>
                <div class="col-md-4">
                    <label for="end_date" class="form-label">Fecha Fin</label>
                    <input type="date" class="form-control" id="end_date" value="{{ date_to }}">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="button" class="btn btn-primary w-100" id="apply-date-range">
                        <i class="bi bi-check-lg me-1"></i>Aplicar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs -->
    <div id="loading-kpis" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Actualizando...</span>
        </div>
    </div>
    
    <div class="row mb-4" id="kpi-container">
        <!-- KPI 1: Órdenes Activas -->
        <div class="col-md-4 col-lg-2 mb-3">
            <div class="card kpi-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary text-white rounded p-3 me-3">
                            <i class="bi bi-clipboard-check fs-4"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="kpi-value text-primary" id="kpi-active-orders">
                                {{ work_order_stats.total_active|default:0 }}
                            </div>
                            <small class="text-muted d-block">Órdenes Activas</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KPI 2: Completadas Hoy -->
        <div class="col-md-4 col-lg-2 mb-3">
            <div class="card kpi-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-success text-white rounded p-3 me-3">
                            <i class="bi bi-check-circle fs-4"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="kpi-value text-success" id="kpi-completed-today">
                                {{ work_order_stats.completed_today|default:0 }}
                            </div>
                            <small class="text-muted d-block">Completadas Hoy</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KPI 3: Completadas Período -->
        <div class="col-md-4 col-lg-2 mb-3">
            <div class="card kpi-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-info text-white rounded p-3 me-3">
                            <i class="bi bi-list-check fs-4"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="kpi-value text-info" id="kpi-completed-period">
                                {{ work_order_stats.completed_period|default:0 }}
                            </div>
                            <small class="text-muted d-block">Completadas Período</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KPI 4: Ingresos del Período -->
        <div class="col-md-4 col-lg-2 mb-3">
            <div class="card kpi-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-warning text-white rounded p-3 me-3">
                            <i class="bi bi-currency-dollar fs-4"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="kpi-value text-warning" id="kpi-revenue">
                                ${{ service_metrics.total_revenue|default:0|floatformat:2 }}
                            </div>
                            <small class="text-muted d-block">Ingresos Período</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KPI 5: Tiempo Promedio -->
        <div class="col-md-4 col-lg-2 mb-3">
            <div class="card kpi-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-danger text-white rounded p-3 me-3">
                            <i class="bi bi-clock-history fs-4"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="kpi-value text-danger" id="kpi-avg-time">
                                {{ service_metrics.avg_completion_time|default:0|floatformat:1 }}d
                            </div>
                            <small class="text-muted d-block">Tiempo Promedio</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KPI 6: Técnicos Activos -->
        <div class="col-md-4 col-lg-2 mb-3">
            <div class="card kpi-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-secondary text-white rounded p-3 me-3">
                            <i class="bi bi-people fs-4"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="kpi-value text-secondary" id="kpi-active-techs">
                                {{ active_technicians_count|default:0 }}
                            </div>
                            <small class="text-muted d-block">Técnicos Activos</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Work Orders by Status -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Órdenes por Estado</h5>
                </div>
                <div class="card-body">
                    {% if work_order_stats.by_status %}
                    <div class="list-group">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-circle-fill text-info me-2"></i>Programadas</span>
                            <span class="badge bg-info">{{ work_order_stats.by_status.scheduled|default:0 }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-circle-fill text-warning me-2"></i>En Progreso</span>
                            <span class="badge bg-warning">{{ work_order_stats.by_status.in_progress|default:0 }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-circle-fill text-success me-2"></i>Completadas</span>
                            <span class="badge bg-success">{{ work_order_stats.by_status.completed|default:0 }}</span>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-center text-muted py-4">No hay datos disponibles</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-people me-2"></i>Top Técnicos</h5>
                </div>
                <div class="card-body">
                    {% if top_technicians %}
                    <div class="list-group">
                        {% for tech in top_technicians %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ tech.name }}</strong>
                                    <small class="text-muted d-block">{{ tech.completed_wo }} órdenes completadas</small>
                                </div>
                                <span class="badge bg-primary">{{ tech.efficiency }}%</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-center text-muted py-4">No hay datos de técnicos</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Work Orders -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Órdenes Recientes</h5>
        </div>
        <div class="card-body">
            {% if recent_work_orders %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Orden #</th>
                            <th>Cliente</th>
                            <th>Servicio</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for wo in recent_work_orders %}
                        <tr>
                            <td><strong>{{ wo.wo_number }}</strong></td>
                            <td>{{ wo.client_name }}</td>
                            <td>{{ wo.service_description|truncatechars:40 }}</td>
                            <td>
                                <span class="badge bg-{{ wo.status_class }}">{{ wo.status }}</span>
                            </td>
                            <td>{{ wo.created_at|date:"d/m/Y" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted py-4">No hay órdenes recientes</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Panel de Alertas Activas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning bg-opacity-10 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                    Alertas Activas del Sistema
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" id="refresh-alerts-btn" title="Actualizar alertas">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <a href="{% url 'frontend:service_alerts_list' %}" class="btn btn-sm btn-outline-primary ms-2">
                        <i class="bi bi-list me-1"></i>Ver Todas
                    </a>
                    <a href="{% url 'frontend:service_alert_thresholds' %}" class="btn btn-sm btn-outline-info ms-2">
                        <i class="bi bi-gear me-1"></i>Configurar
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div id="alerts-container">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando alertas...</span>
                        </div>
                        <p class="text-muted mt-2 mb-0">Cargando alertas activas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sección de Gráficos Interactivos -->
<div class="row mb-4" id="charts-section">
    <!-- Gráfico 1: Productividad por Técnico -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-people me-2"></i>Productividad por Técnico</h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="ServiceDashboardCharts.exportChart('productivity', 'png')">
                    <i class="bi bi-download me-1"></i>Exportar
                </button>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 300px;">
                    <canvas id="productivityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gráfico 2: Servicios por Categoría -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Distribución por Tipo de Servicio</h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="ServiceDashboardCharts.exportChart('categories', 'png')">
                    <i class="bi bi-download me-1"></i>Exportar
                </button>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 300px;">
                    <canvas id="servicesCategoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gráfico 3: Tendencias Temporales -->
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Tendencias Temporales</h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="ServiceDashboardCharts.exportChart('trends', 'png')">
                    <i class="bi bi-download me-1"></i>Exportar
                </button>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 350px;">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gráfico 4: Comparación de Períodos -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-bar-chart-steps me-2"></i>Comparación de Períodos</h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="ServiceDashboardCharts.exportChart('comparison', 'png')">
                    <i class="bi bi-download me-1"></i>Exportar
                </button>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 350px;">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Dashboard scripts -->
<script src="{% static 'frontend/js/services/dashboard.js' %}"></script>
<script src="{% static 'frontend/js/services/dashboard-charts.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar dashboard
    ServiceDashboard.init({
        statsApiUrl: '{% url "frontend:service_stats_api" %}',
        period: '{{ period }}',
        dateFrom: '{{ date_from }}',
        dateTo: '{{ date_to }}',
        csrfToken: '{{ csrf_token }}'
    });
    
    // Selector de período
    const periodRadios = document.querySelectorAll('input[name="period"]');
    const customDateRange = document.getElementById('custom-date-range');
    
    periodRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDateRange.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
                // Recargar con nuevo período
                const url = new URL(window.location);
                url.searchParams.set('period', this.value);
                window.location.href = url.toString();
            }
        });
    });
    
    // Aplicar rango de fechas personalizado
    document.getElementById('apply-date-range')?.addEventListener('click', function() {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        if (startDate && endDate) {
            const url = new URL(window.location);
            url.searchParams.set('period', 'custom');
            url.searchParams.set('start_date', startDate);
            url.searchParams.set('end_date', endDate);
            window.location.href = url.toString();
        }
    });
    
    // Botón de actualizar
    document.getElementById('refresh-dashboard')?.addEventListener('click', function() {
        ServiceDashboard.refreshKPIs();
        if (ServiceDashboardCharts.instance) {
            ServiceDashboardCharts.instance.loadAllCharts();
        }
        loadAlerts(); // También actualizar alertas
    });
    
    // Cargar y actualizar alertas
    function loadAlerts() {
        const container = document.getElementById('alerts-container');
        if (!container) return;
        
        fetch('{% url "frontend:service_alerts_api" %}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderAlerts(data.alerts, data.stats);
                } else {
                    container.innerHTML = '<div class="alert alert-warning">Error al cargar alertas</div>';
                }
            })
            .catch(error => {
                console.error('Error loading alerts:', error);
                container.innerHTML = '<div class="alert alert-danger">Error de conexión al cargar alertas</div>';
            });
    }
    
    function renderAlerts(alerts, stats) {
        const container = document.getElementById('alerts-container');
        
        if (!alerts || alerts.length === 0) {
            container.innerHTML = `
                <div class="alert alert-success mb-0">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    No hay alertas activas. Todo funciona correctamente.
                </div>
            `;
            return;
        }
        
        let html = '<div class="row g-2">';
        
        alerts.forEach(alert => {
            const severity = alert.severity || 'medium';
            const alertClass = {
                'critical': 'danger',
                'high': 'warning',
                'medium': 'info',
                'low': 'secondary'
            }[severity] || 'info';
            
            const icon = {
                'critical': 'exclamation-triangle-fill',
                'high': 'exclamation-circle-fill',
                'medium': 'info-circle-fill',
                'low': 'check-circle-fill'
            }[severity] || 'info-circle';
            
            html += `
                <div class="col-md-6 col-lg-4">
                    <div class="alert alert-${alertClass} alert-dismissible fade show mb-2" role="alert">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-${icon} me-2 mt-1"></i>
                            <div class="flex-grow-1">
                                <strong>${escapeHtml(alert.title)}</strong>
                                <p class="mb-1 small">${escapeHtml(alert.message)}</p>
                                ${alert.action_url ? `<a href="${alert.action_url}" class="btn btn-sm btn-outline-${alertClass} mt-1">Ver Detalles</a>` : ''}
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        // Agregar resumen de estadísticas
        if (stats) {
            const statsHtml = `
                <div class="mt-3 pt-3 border-top">
                    <div class="row text-center">
                        <div class="col-3">
                            <small class="text-muted d-block">Críticas</small>
                            <strong class="text-danger">${stats.by_severity?.critical || 0}</strong>
                        </div>
                        <div class="col-3">
                            <small class="text-muted d-block">Altas</small>
                            <strong class="text-warning">${stats.by_severity?.high || 0}</strong>
                        </div>
                        <div class="col-3">
                            <small class="text-muted d-block">Medias</small>
                            <strong class="text-info">${stats.by_severity?.medium || 0}</strong>
                        </div>
                        <div class="col-3">
                            <small class="text-muted d-block">Totales</small>
                            <strong>${stats.total || 0}</strong>
                        </div>
                    </div>
                </div>
            `;
            html += statsHtml;
        }
        
        container.innerHTML = html;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Botón de actualizar alertas
    document.getElementById('refresh-alerts-btn')?.addEventListener('click', loadAlerts);
    
    // Cargar alertas inicialmente
    loadAlerts();
    
    // Configurar Server-Sent Events para notificaciones en tiempo real
    let eventSource = null;
    
    function initSSE() {
        // Cerrar conexión anterior si existe
        if (eventSource) {
            eventSource.close();
        }
        
        // Crear nueva conexión SSE
        eventSource = new EventSource('{% url "frontend:service_alerts_sse" %}');
        
        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            if (data.type === 'alerts_update') {
                // Actualizar alertas cuando haya cambios
                renderAlerts(data.alerts, data.stats);
            } else if (data.type === 'connected') {
                console.log('SSE connected for real-time alerts');
            } else if (data.type === 'heartbeat') {
                // Mantener conexión viva
                console.debug('SSE heartbeat');
            } else if (data.type === 'error') {
                console.error('SSE error:', data.message);
                // Fallback a polling si SSE falla
                eventSource.close();
                setInterval(loadAlerts, 60000);
            }
        };
        
        eventSource.onerror = function(error) {
            console.error('SSE connection error:', error);
            // Fallback a polling si SSE falla
            if (eventSource.readyState === EventSource.CLOSED) {
                eventSource.close();
                setInterval(loadAlerts, 60000);
            }
        };
    }
    
    // Inicializar SSE para notificaciones en tiempo real
    try {
        initSSE();
    } catch (e) {
        console.warn('SSE not supported, falling back to polling:', e);
        // Fallback a polling si el navegador no soporta SSE
        setInterval(loadAlerts, 60000);
    }
    
    // También mantener polling como respaldo (cada 60 segundos)
    setInterval(loadAlerts, 60000);
    
    // Inicializar gráficos
    ServiceDashboardCharts.init({
        productivityUrl: '{% url "frontend:service_productivity_api" %}',
        categoriesUrl: '{% url "frontend:service_categories_api" %}',
        trendsUrl: '{% url "frontend:service_trends_api" %}',
        comparisonUrl: '{% url "frontend:service_comparison_api" %}',
        csrfToken: '{{ csrf_token }}',
        period: '{{ period }}',
        dateFrom: '{{ date_from }}',
        dateTo: '{{ date_to }}'
    });
    
    // Actualizar gráficos cuando cambie el período (si es mediante AJAX)
    // Nota: Actualmente el cambio de período recarga la página completa
    // pero dejamos preparado para futuras mejoras
});
</script>
{% endblock %}
